= Dialog Manager Sample
// --- D O N ' T    T O U C H   T H I S    S E C T I O N ---
ifndef::env-github[]
:toc: left
endif::[]

ifdef::env-github[]
:toc:
:toc-placement!:
endif::[]

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

ifndef::env-github[]
:icons: font
endif::[]
// ----------------------------------------------------------



// Write a short summary here what this examples does
This example will show you how to write a service (we will call it dialog manager) that will help you to show dialogs in your MVVM application.



// --- D O N ' T    T O U C H   T H I S    S E C T I O N ---
toc::[]
// ---------------------------------------------------------


[discrete]
=== Difficulty
// Choose one of the below difficulties. You can just delete the ones you don't need.

üêî Normal üêî


[discrete]
=== Buzz-Words

// Write some buzz-words here. You can separate them by ", "
MVVM, Dialog, FileDialogs, TopLevel, Clipboard, DialogManager, CommunityToolkit.MVVM


== Before we start

We assume you already now how the MVVM pattern works and how dialogs, such as file dialogs, can be shown in general. You should also know what a https://docs.avaloniaui.net/docs/next/concepts/toplevel[[TopLevel\]]-control in Avalonia is and what it can be used for. 

NOTE: In this sample we will use the https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/[[CommunityToolkit.MVVM\]]-package which provides source generators for less boilerplate code. Please check out their docs if you want to learn more about this. (https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/generators/overview)

WARNING: We use partial properties that were introduced in .NET 10. If you haven't updated yet, you need to add `<LangVersion>preview</LangVersion>` to a property group in your `.csproj` file. 

== The Solution : Use a DialogService to show a Dialog

// This is where you explain the possible solution you provide in this sample. 
// If you have more than one option to solve the issue, use Approach 1, Approach 2, ... 

=== Step 1: Add the DialogManager-class

In our project we add a folder called `Services`. Inside we will create a class called `DialogManager`.

NOTE: We do not need to inherit `AvaloniaObject` even as we want to add `Register` as an `AttachedProperty` because Avalonia supports AttachedProperties on any object. 

Additionally, we will add an interface called `IDialogParticipant` which any class need to implement, that want to use the dialog manager. 

TIP: Technically we can also map to `object` or any other base class, but since we later on want to use extension methods these will leak into any object. Having the interface introduce will only show the extension methods where they are useful. 

Comming back to the DialogManager-class, let's add a static `Dictionary` where we can store the registered mappings between the context (for example our `ViewModel`) and the `View` or `Control`, which we want to interact with.

[source,cs]
----
public class DialogManager
{
    private static readonly Dictionary<IDialogParticipant, Visual> RegistrationMapper =
        new Dictionary<IDialogParticipant, Visual>();
}
----

In the next step we add an https://docs.avaloniaui.net/docs/next/concepts/attached-property[[AttachedProperty]] to our dialog manager, which we call `Register`. Later we can bind any `IDialogParticipant` to this property from every available `Visual` in our `Views`.

[source,cs]
----
/// <summary>
/// This property handles the registration of Views and ViewModel
/// </summary>
public static readonly AttachedProperty<IDialogParticipant?> RegisterProperty = AvaloniaProperty.RegisterAttached<DialogManager, Visual, IDialogParticipant?>(
    "Register");

/// <summary>
/// Accessor for Attached property <see cref="RegisterProperty"/>.
/// </summary>
public static void SetRegister(AvaloniaObject element, IDialogParticipant value)
{
    element.SetValue(RegisterProperty, value);
}

/// <summary>
/// Accessor for Attached property <see cref="RegisterProperty"/>.
/// </summary>
public static IDialogParticipant? GetRegister(AvaloniaObject element)
{
    return element.GetValue(RegisterProperty);
}
----

Now that we want to store or remove any new binding into our `Dictionary`, we need to listen to changes of the `RegisterProperty`. We can add such a listener inside the static constructor.

[source,cs]
----
static DialogManager()
{
    RegisterProperty.Changed.AddClassHandler<Visual>(RegisterChanged);
}

private static void RegisterChanged(Visual sender, AvaloniaPropertyChangedEventArgs e)
{
    if (sender is null)
    {
        throw new InvalidOperationException("The DialogManager can only be registered on a Visual");
    }

    // Unregister any old registered context
    if (e.GetOldValue<IDialogParticipant>() is { } oldValue)
    {
        RegistrationMapper.Remove(oldValue);
    }

    // Register any new context
    if (e.GetNewValue<IDialogParticipant>() is { } newValue)
    {
        RegistrationMapper.Add(newValue, sender);
    }
}
----


=== Step 2: Add methods to look up the view

To make our life easier, we add can add some static functions to look up the registered view.

[source,cs]
----
/// <summary>
/// Gets the associated <see cref="Visual"/> for a given context. Returns null, if none was registered
/// </summary>
/// <param name="context">The context to lookup</param>
/// <returns>The registered Visual for the context or null if none was found</returns>
public static Visual? GetVisualForContext(IDialogParticipant context)
{
    return RegistrationMapper.TryGetValue(context, out var result) ? result : null;
}

/// <summary>
/// Gets the parent <see cref="TopLevel"/> for the given context. Returns null, if no TopLevel was found
/// </summary>
/// <param name="context">The context to lookup</param>
/// <returns>The registered TopLevel for the context or null if none was found</returns>
public static TopLevel? GetTopLevelForContext(IDialogParticipant context)
{
    return TopLevel.GetTopLevel(GetVisualForContext(context));
}
----

=== Step 3: Create extension methods

If we are even more lazy, we can add some extension methods which we can use later to call a dialog in one line. To do this we add a new static class `DialogHelper` into our `Services`-folder. 

[source,cs]
----
/// <summary>
/// A helper class to manage dialogs via extension methods. Add more on your own
/// </summary>
public static class DialogHelper 
{ 
    /// <summary>
    /// Shows an open file dialog for a registered context, most likely a ViewModel
    /// </summary>
    /// <param name="context">The context</param>
    /// <param name="title">The dialog title or a default is null</param>
    /// <param name="selectMany">Is selecting many files allowed?</param>
    /// <returns>An array of file names</returns>
    /// <exception cref="ArgumentNullException">if context was null</exception>
    public static async Task<IEnumerable<string>?> OpenFileDialogAsync(this IDialogParticipant? context,
        string? title = null,
        bool selectMany = true)
    {
        ArgumentNullException.ThrowIfNull(context);

        // lookup the TopLevel for the context. If no TopLevel was found, we throw an exception
        var topLevel = DialogManager.GetTopLevelForContext(context)
                       ?? throw new InvalidOperationException("No TopLevel was resolved for the given context.");

        // Open the file dialog
        var storageFiles = await topLevel.StorageProvider.OpenFilePickerAsync(
            new FilePickerOpenOptions()
            {
                AllowMultiple = selectMany,
                Title = title ?? "Select any file(s)"
            });

        // return the result
        return storageFiles.Select(s => s.Name);
    }
}
----

TIP: Please have a look in the samples code for some more possible options. The `DialogHelper` can be part of a separate controls library or part of your application. A mix is also possible.

=== Step 4: Usage

Now that we have our `DialogManager` created, we can start to register the `View` for our `ViewModel`. Only thing left to adjust is to implement the `IDialogParticipant`-interface on our `ViewModel`.

[source,cs]
----
public partial class MainWindowViewModel : ViewModelBase, IDialogParticipant
----

Thanks to our attached property, we can now simply do:

[source,xml]
----
<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:services="using:DialogManagerSample.Services"
             services:DialogManager.Register="{Binding}">
    <!-- Your content goes here -->
</UserControl>

----

And in the `ViewModel` we can use our extension methods anywhere. The below sample command will ask the user to select a bunch of files. The command itself will be created using the source generators that the CommunityToolkit.MVVM-package provides.

[source,c#]
----
[RelayCommand]
private async Task SelectFilesAsync()
{
    // Selected Files is a property of our ViewModel
    SelectedFiles = await this.OpenFileDialogAsync("Hello Avalonia");
}
----

Now we can add the needed `List` and `Button` in our view:

[source,xml]
----
<Grid RowDefinitions="Auto,*,Auto">
    <TextBlock Text="Selected Files:" />
    <ListBox ItemsSource="{Binding SelectedFiles}" Grid.Row="1" />
    <Button Content="Select Files"
            Command="{Binding SelectFilesCommand}"
            Grid.Row="2" />
</Grid>
----


=== Step 5: See it in action

Run the App and try to select as many files as you like.

image::_docs/result.png[Advanced Dialog Sample]

== Related 

TIP: In the source code of this sample we have some more dialogs applied. Feel free to explore those and play around with them.

There are more ways to show dialogs from the ViewModel, for example: 
  
* link:../MvvmDialogSample[Interactions]
* https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/messenger[MVVM-Toolkits Messenger] (The link:../../CompleteApps/Avalonia.MusicStore/[[Music-Store\]] tutorial uses this approach)
* https://github.com/AvaloniaCommunity/awesome-avalonia#mvvm--mvp--mvu[third party libs]



// --------------- Ascii-Doc Cheat-Sheet ------------------

// visit: https://asciidoc.org 
// visit: https://powerman.name/doc/asciidoc-compact

// VS-Code has a great Add-In for Ascii docs: https://github.com/asciidoctor/asciidoctor-vscode/