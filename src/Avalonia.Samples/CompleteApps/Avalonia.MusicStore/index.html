<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.26">
<link rel="icon" type="image/svg" href="../../../../_docs/_Assets/Logo.svg">
<title>Music Store App</title>
<style>
@import url(https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css);

:root {
    --background: #fff;
    --black-color: #000;
    --background-yellow: #ff0;
    --border: #c0c0c0;
    --gray-color: #6c818f;
    --link-color-default: var(--accent-primary-color);
    --foreground-color: #222222;
    --accent-primary-color: #3578e5;
    --accent-secondary-color: #102445;
    --border2: #dddddd;
    --block-quote-color: #748590;
    --pre-background-color: #f2f2f2;
    --dark-gray-color: #333333;
    --kdb-background-color: #F7F7F7;
    --header-color: var(--accent-primary-color);
    --link-hover-color: #102445;
    --toc-border-color: #d9d9d9;
    --exampleblock-border-color: #e6e6e6;
    --em-color: #373737;
    --admotion-background-color: #e6e6e6;
    --sidebar-background-color: #e8ecef;
    --border-radius-default: 6px;
}

/* normalize.css v2.1.1 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary {
    display: block;
}

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video {
    display: inline-block;
}

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) {
    display: none;
    height: 0;
}

/** Address styling not present in IE 8/9. */
[hidden] {
    display: none;
}

/* ========================================================================== Base ========================================================================== */
/** 1. Prevent system color scheme's background color being used in Firefox, IE, and Opera. 2. Prevent system color scheme's text color being used in Firefox, IE, and Opera. 3. Set default font family to sans-serif. 4. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html {
    background: var(--background); /* 1 */
    color: var(--black-color); /* 2 */
    font-family: sans-serif; /* 3 */
    -ms-text-size-adjust: 100%; /* 4 */
    -webkit-text-size-adjust: 100%; /* 4 */
}

/** Remove default margin. */
body {
    margin: 0;
}

/* ========================================================================== Links ========================================================================== */
/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus {
    outline: thin dotted;
}

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover {
    outline: 0;
}

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] {
    border-bottom: 1px dotted;
}

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong {
    font-weight: bold;
}

/** Address styling not present in Safari 5 and Chrome. */
dfn {
    font-style: italic;
}

/** Address differences between Firefox and other browsers. */
hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/** Address styling not present in IE 8/9. */
mark {
    background: var(--background-yellow);
    color: var(--black-color);
}

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp {
    font-family: monospace, serif;
    font-size: 1em;
}

/** Improve readability of pre-formatted text in all browsers. */
pre {
    white-space: pre-wrap;
}

/** Set consistent quote types. */
q {
    quotes: "\201C" "\201D" "\2018" "\2019";
}

/** Address inconsistent and variable font size in all browsers. */
small {
    font-size: 80%;
}

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img {
    border: 0;
}

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) {
    overflow: hidden;
}

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure {
    margin: 0;
}

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset {
    border: 1px solid var(--border);
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend {
    border: 0; /* 1 */
    padding: 0; /* 2 */
}

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea {
    font-family: inherit; /* 1 */
    font-size: 100%; /* 2 */
    margin: 0; /* 3 */
}

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input {
    line-height: normal;
}

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select {
    text-transform: none;
}

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
}

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] {
    cursor: default;
}

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
}

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table {
    border-collapse: collapse;
    border-spacing: 0;
}

*, *:before, *:after {
    -moz-box-sizing: border-box;
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
}

html, body {
    font-size: 100%;
}

body {
    background: white;
    color: var(--foreground-color);
    padding: 0;
    margin: 0;
    font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif;
    font-weight: normal;
    font-style: normal;
    line-height: 1;
    position: relative;
    cursor: auto;
}

a:hover {
    cursor: pointer;
}

a:focus {
    outline: none;
}

img, object, embed {
    max-width: 100%;
    height: auto;
}

object, embed {
    height: 100%;
}

img {
    -ms-interpolation-mode: bicubic;
}

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object {
    max-width: none !important;
}

.left {
    float: left !important;
}

.right {
    float: right !important;
}

.text-left {
    text-align: left !important;
}

.text-right {
    text-align: right !important;
}

.text-center {
    text-align: center !important;
}

.text-justify {
    text-align: justify !important;
}

.hide {
    display: none;
}

.antialiased, body {
    -webkit-font-smoothing: antialiased;
}

img {
    display: inline-block;
    vertical-align: middle;
}

textarea {
    height: auto;
    min-height: 50px;
}

select {
    width: 100%;
}

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p {
    font-size: 1.21875em;
    line-height: 1.6;
}

.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption {
    line-height: 1.4;
    color: var(--accent-primary-color);
    font-weight: 300;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td {
    margin: 0;
    /*padding: 0;*/
    direction: ltr;
}

/* Default Link Styles */
a {
    color: var(--link-color-default);
    text-decoration: none;
    line-height: inherit;
}

a:hover, a:focus {
    color: var(--header-color);
}

a img {
    border: none;
}

/* Default paragraph styles */
p {
    font-family: inherit;
    font-weight: normal;
    font-size: 1em;
    line-height: 1.5;
    margin-bottom: 1.25em;
    text-rendering: optimizeLegibility;
}

p aside {
    font-size: 0.875em;
    line-height: 1.35;
    font-style: italic;
}

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
    font-family: ff-meta-web-pro-1, ff-meta-web-pro-2, Arial, "Helvetica Neue", sans-serif;
    font-weight: bold;
    font-style: normal;
    color: var(--accent-primary-color);
    text-rendering: optimizeLegibility;
    margin-top: 1em;
    margin-bottom: 0.5em;
    line-height: 1.2125em;
}

h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small {
    font-size: 60%;
    color: var(--accent-secondary-color);
    line-height: 0;
}

h1 {
    font-size: 2.125em;
}

h2 {
    font-size: 1.6875em;
}

h3, #toctitle, .sidebarblock > .content > .title {
    font-size: 1.375em;
}

h4 {
    font-size: 1.125em;
}

h5 {
    font-size: 1.125em;
}

h6 {
    font-size: 1em;
}

hr {
    border: solid var(--border2);
    border-width: 1px 0 0;
    clear: both;
    margin: 1.25em 0 1.1875em;
    height: 0;
}

/* Helpful Typography Defaults */
em, i {
    font-style: italic;
    line-height: inherit;
}

strong, b {
    font-weight: bold;
    line-height: inherit;
}

small {
    font-size: 60%;
    line-height: inherit;
}

code {
    font-family: "Consolas", "Deja Vu Sans Mono", "Bitstream Vera Sans Mono", monospace;
    font-weight: normal;
    color: var(--link-color-default);
}

/* Lists */
ul, ol, dl {
    font-size: 1em;
    line-height: 1.5;
    margin-bottom: 1.25em;
    list-style-position: outside;
    font-family: inherit;
}

ul, ol {
    margin-left: 0;
}

/* Unordered Lists */
ul li ul, ul li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
    font-size: 1em; /* Override nested font-size change */
}

ul.square li ul, ul.circle li ul, ul.disc li ul {
    list-style: inherit;
}

ul.square {
    list-style-type: square;
}

ul.circle {
    list-style-type: circle;
}

ul.disc {
    list-style-type: disc;
}

ul.no-bullet {
    list-style: none;
}

/* Ordered Lists */
ol li ul, ol li ol {
    margin-left: 1.25em;
    margin-bottom: 0;
}

/* Definition Lists */
dl dt {
    margin-bottom: 0.3em;
    font-weight: bold;
}

dl dd {
    margin-bottom: 0.75em;
}

/* Abbreviations */
abbr, acronym {
    text-transform: uppercase;
    font-size: 90%;
    color: black;
    border-bottom: 1px dotted var(--border2);
    cursor: help;
}

abbr {
    text-transform: none;
}

/* Blockquotes */
blockquote {
    margin: 0 0 1.25em;
    padding: 0.5625em 1.25em 0 1.1875em;
    border-left: 1px solid var(--border2);
}

blockquote cite {
    display: block;
    font-size: 0.8125em;
    color: var(--block-quote-color);
}

blockquote cite:before {
    content: "\2014 \0020";
}

blockquote cite a, blockquote cite a:visited {
    color: var(--block-quote-color);
}

blockquote, blockquote p {
    line-height: 1.5;
    color: var(--accent-secondary-color);
}

/* Microformats */
.vcard {
    display: inline-block;
    margin: 0 0 1.25em 0;
    border: 1px solid var(--border2);
    padding: 0.625em 0.75em;
}

.vcard li {
    margin: 0;
    display: block;
}

.vcard .fn {
    font-weight: bold;
    font-size: 0.9375em;
}

.vevent .summary {
    font-weight: bold;
}

.vevent abbr {
    cursor: auto;
    text-decoration: none;
    font-weight: bold;
    border: none;
    padding: 0 0.0625em;
}

@media only screen and (min-width: 768px) {
    h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 {
        line-height: 1.4;
    }

    h1 {
        font-size: 2.75em;
    }

    h2 {
        font-size: 2.3125em;
    }

    h3, #toctitle, .sidebarblock > .content > .title {
        font-size: 1.6875em;
    }

    h4 {
        font-size: 1.4375em;
    }
}

/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only {
    display: none !important;
}

@media print {
    * {
        background: transparent !important;
        color: var(--black-color) !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a, a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after {
        content: "";
    }

    pre, blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr, img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p, h2, h3, #toctitle, .sidebarblock > .content > .title {
        orphans: 3;
        widows: 3;
    }

    h2, h3, #toctitle, .sidebarblock > .content > .title {
        page-break-after: avoid;
    }

    .hide-on-print {
        display: none !important;
    }

    .print-only {
        display: block !important;
    }

    .hide-for-print {
        display: none !important;
    }

    .show-for-print {
        display: inherit !important;
    }
}

/* Tables */
table {
    background: white;
    margin-bottom: 1.25em;
    border: solid 0 var(--border2);
}

table thead, table tfoot {
    background: none;
    font-weight: bold;
}

table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td {
    padding: 1px 8px 1px 5px;
    font-size: 1em;
    color: var(--foreground-color);
    text-align: left;
}

table tr th, table tr td {
    padding: 1px 8px 1px 5px;
    font-size: 1em;
    color: var(--foreground-color);
}

table tr.even, table tr.alt, table tr:nth-of-type(even) {
    background: none;
}

table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td {
    display: table-cell;
    line-height: 1.5;
}

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after {
    content: " ";
    display: table;
}

.clearfix:after, .float-group:after {
    clear: both;
}

*:not(pre) > code {
    font-size: 0.95em;
    padding: 0;
    white-space: nowrap;
    background-color: var(--pre-background-color);
    border: 0 solid var(--border2);
    -webkit-border-radius: var(--border-radius-default);
    border-radius: var(--border-radius-default);
    text-shadow: none;
}

pre, pre > code {
    line-height: 1.2;
    color: inherit;
    font-family: "Consolas", "Deja Vu Sans Mono", "Bitstream Vera Sans Mono", monospace;
    font-weight: normal;
}

kbd.keyseq {
    color: var(--dark-gray-color);
}

kbd:not(.keyseq) {
    display: inline-block;
    color: black;
    font-size: 0.75em;
    line-height: 1.4;
    background-color: var(--kdb-background-color);
    border: 1px solid #ccc;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset;
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset;
    margin: -0.15em 0.15em 0 0.15em;
    padding: 0.2em 0.6em 0.2em 0.5em;
    vertical-align: middle;
    white-space: nowrap;
}

kbd kbd:first-child {
    margin-left: 0;
}

kbd kbd:last-child {
    margin-right: 0;
}

.menuseq, .menu {
    color: black;
}

p a > code:hover {
    color: var(--link-hover-color);
}

#header, #content, #footnotes, #footer {
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    margin-top: 0;
    margin-bottom: 0;
    max-width: 62.5em;
    *zoom: 1;
    position: relative;
    padding-left: 0.9375em;
    padding-right: 0.9375em;
}

#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after {
    content: " ";
    display: table;
}

#header:after, #content:after, #footnotes:after, #footer:after {
    clear: both;
}

#header {
    margin-bottom: 2.5em;
}

#header > h1 {
    color: var(--header-color);
    font-weight: bold;
    border-bottom: 1px solid var(--border2);
    margin-bottom: -28px;
    padding-bottom: 32px;
}

#header span {
    color: var(--accent-secondary-color);
}

#header #revnumber {
    text-transform: capitalize;
}

#header br {
    display: none;
}

#header br + span {
    padding-left: 3px;
}

#header br + span:before {
    content: "\2013 \0020";
}

#header br + span.author {
    padding-left: 0;
}

#header br + span.author:before {
    content: ", ";
}

#toc {
    border-bottom: 1px solid var(--border2);
    padding-bottom: 1.25em;
}

#toc > ul {
    margin-left: 0.25em;
}

#toc ul.sectlevel0 > li > a {
    font-style: italic;
}

#toc ul.sectlevel0 ul.sectlevel1 {
    margin-left: 0;
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}

#toc ul {
    list-style-type: none;
}

#toctitle {
    color: var(--accent-primary-color);
}

@media only screen and (min-width: 1280px) {
    body.toc2 {
        padding-left: 20em;
    }

    #toc.toc2 {
        position: fixed;
        width: 20em;
        left: 0;
        top: 0;
        border-right: 1px solid var(--border2);
        border-bottom: 0;
        z-index: 1000;
        padding: 44px 1em 1em;
        height: 100%;
        overflow: auto;
    }

    #toc.toc2 > ul {
        padding-left: 1em;
    }

    #toc.toc2 #toctitle {
        margin-top: 0;
    }

    #toc.toc2 > ul {
        font-size: .95em;
    }

    #toc.toc2 ul ul {
        margin-left: 0;
        padding-left: 1.25em;
    }

    #toc.toc2 ul.sectlevel0 ul.sectlevel1 {
        padding-left: 0;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
    }

    body.toc2.toc-right {
        padding-left: 0;
        padding-right: 20em;
    }

    body.toc2.toc-right #toc.toc2 {
        border-right: 0;
        border-left: 1px solid var(--border2);
        left: auto;
        right: 0;
    }
}

#content #toc {
    border-style: solid;
    border-width: 1px;
    border-color: var(--toc-border-color);
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: var(--pre-background-color);
    border-width: 0;
    -webkit-border-radius: var(--border-radius-default);
    border-radius: var(--border-radius-default);
}

#content #toc > :first-child {
    margin-top: 0;
}

#content #toc > :last-child {
    margin-bottom: 0;
}

#content #toc a {
    color: var(--gray-color);
    text-decoration: none;
}

#content #toctitle {
    font-weight: bold;
    font-family: ff-meta-web-pro-1, ff-meta-web-pro-2, Arial, "Helvetica Neue", sans-serif;
    font-size: 1em;
    padding-left: 0.125em;
}

#footer {
    max-width: 100%;
    background-color: black;
    padding: 1.25em;
}

#footer-text {
    color: white;
    line-height: 1.35;
}

.sect1 {
    padding-bottom: 1.25em;
}

.sect1 + .sect1 {
    border-top: 1px solid var(--border2);
}

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor {
    position: absolute;
    width: 1em;
    margin-left: -1em;
    display: block;
    text-decoration: none;
    visibility: hidden;
    text-align: center;
    font-weight: normal;
}

#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before {
    content: '\00A7';
    font-size: .85em;
    vertical-align: text-top;
    display: block;
    margin-top: 0.05em;
}

#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover {
    visibility: visible;
}

#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link {
    color: var(--accent-primary-color);
    text-decoration: none;
}

#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover {
    color: var(--link-hover-color);
}

.imageblock, .literalblock, .listingblock, .verseblock, .videoblock {
    margin-bottom: 1.25em;
}

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title {
    text-align: left;
    font-weight: bold;
}

.tableblock > caption {
    text-align: left;
    font-weight: bold;
    white-space: nowrap;
    overflow: visible;
    max-width: 0;
}

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p {
    font-size: inherit;
}

.admonitionblock > table {
    border: 0;
    background: none;
    width: 100%;
}

.admonitionblock > table td.icon {
    text-align: center;
    width: 60px;
    padding: 0;
    font-size: 1.5em;
}

.admonitionblock > table td.icon img {
    max-width: none;
}

.admonitionblock > table td.icon .title {
    font-weight: bold;
    text-transform: uppercase;
}

.admonitionblock > table td.content {
    /*padding-left: 1.125em;*/
    /*padding-right: 1.25em;*/
    border-left: 1px solid var(--border2);
    color: var(--accent-secondary-color);
}

.admonitionblock > table td.content > :last-child > :last-child {
    margin-bottom: 0;
}

.exampleblock > .content {
    border-style: solid;
    border-width: 1px;
    border-color: var(--exampleblock-border-color);
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: white;
    -webkit-border-radius: var(--border-radius-default);
    border-radius: var(--border-radius-default);
}

.exampleblock > .content > :first-child {
    margin-top: 0;
}

.exampleblock > .content > :last-child {
    margin-bottom: 0;
}

.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p {
    color: var(--dark-gray-color);
}

.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 {
    line-height: 1;
    margin-bottom: 0.625em;
}

.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader {
    line-height: 1.4;
}

.exampleblock.result > .content {
    -webkit-box-shadow: 0 1px 8px var(--toc-border-color);
    box-shadow: 0 1px 8px var(--toc-border-color);
}

.sidebarblock {
    border-style: solid;
    border-width: 1px;
    border-color: var(--toc-border-color);
    margin-bottom: 1.25em;
    padding: 1.25em;
    background: var(--pre-background-color);
    -webkit-border-radius: var(--border-radius-default);
    border-radius: var(--border-radius-default);
}

.sidebarblock > :first-child {
    margin-top: 0;
}

.sidebarblock > :last-child {
    margin-bottom: 0;
}

.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p {
    color: var(--dark-gray-color);
}

.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 {
    line-height: 1;
    margin-bottom: 0.625em;
}

.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader {
    line-height: 1.4;
}

.sidebarblock > .content > .title {
    color: var(--gray-color);
    margin-top: 0;
    line-height: 1.5;
}

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child {
    margin-bottom: 0;
}

.literalblock > .content pre, .listingblock > .content pre {
    background: #eeeeee;
    border-width: 1px;
    border-style: solid;
    border-color: #cccccc;
    -webkit-border-radius: var(--border-radius-default);
    border-radius: var(--border-radius-default);
    padding: 0.5em;
    word-wrap: break-word;
}

.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap {
    overflow-x: auto;
    white-space: pre;
    word-wrap: normal;
}

.literalblock > .content pre > code, .listingblock > .content pre > code {
    display: block;
}

@media only screen {
    .literalblock > .content pre, .listingblock > .content pre {
        font-size: 0.76em;
    }
}

@media only screen and (min-width: 768px) {
    .literalblock > .content pre, .listingblock > .content pre {
        font-size: 0.855em;
    }
}

@media only screen and (min-width: 1280px) {
    .literalblock > .content pre, .listingblock > .content pre {
        font-size: 0.95em;
    }
}

.listingblock > .content {
    position: relative;
}

.listingblock:hover code[class*=" language-"]:before {
    text-transform: uppercase;
    font-size: 0.9em;
    color: #999;
    position: absolute;
    top: 0.375em;
    right: 0.375em;
}

.listingblock:hover code.asciidoc:before {
    content: "asciidoc";
}

.listingblock:hover code.clojure:before {
    content: "clojure";
}

.listingblock:hover code.css:before {
    content: "css";
}

.listingblock:hover code.groovy:before {
    content: "groovy";
}

.listingblock:hover code.html:before {
    content: "html";
}

.listingblock:hover code.java:before {
    content: "java";
}

.listingblock:hover code.javascript:before {
    content: "javascript";
}

.listingblock:hover code.python:before {
    content: "python";
}

.listingblock:hover code.ruby:before {
    content: "ruby";
}

.listingblock:hover code.scss:before {
    content: "scss";
}

.listingblock:hover code.xml:before {
    content: "xml";
}

.listingblock:hover code.yaml:before {
    content: "yaml";
}

.listingblock.terminal pre .command:before {
    content: attr(data-prompt);
    padding-right: 0.5em;
    color: #999;
}

.listingblock.terminal pre .command:not([data-prompt]):before {
    content: '$';
}

table.pyhltable {
    border: 0;
    margin-bottom: 0;
}

table.pyhltable td {
    vertical-align: top;
    padding-top: 0;
    padding-bottom: 0;
}

table.pyhltable td.code {
    padding-left: .75em;
    padding-right: 0;
}

.highlight.pygments .lineno, table.pyhltable td:not(.code) {
    color: #999;
    padding-left: 0;
    padding-right: .5em;
    border-right: 1px solid var(--border2);
}

.highlight.pygments .lineno {
    display: inline-block;
    margin-right: .25em;
}

table.pyhltable .linenodiv {
    background-color: transparent !important;
    padding-right: 0 !important;
}

.quoteblock {
    margin: 0 0 1.25em;
    padding: 0.5625em 1.25em 0 1.1875em;
    border-left: 1px solid var(--border2);
}

.quoteblock blockquote {
    margin: 0 0 1.25em 0;
    padding: 0 0 0.5625em 0;
    border: 0;
}

.quoteblock blockquote > .paragraph:last-child p {
    margin-bottom: 0;
}

.quoteblock .attribution {
    margin-top: -.25em;
    padding-bottom: 0.5625em;
    font-size: 0.8125em;
    color: var(--block-quote-color);
}

.quoteblock .attribution br {
    display: none;
}

.quoteblock .attribution cite {
    display: block;
    margin-bottom: 0.625em;
}

table thead th, table tfoot th {
    font-weight: bold;
}

table.tableblock.grid-all {
    border-collapse: separate;
    border-spacing: 1px;
    -webkit-border-radius: var(--border-radius-default);
    border-radius: var(--border-radius-default);
    border-top: 0 solid var(--border2);
    border-bottom: 0 solid var(--border2);
}

table.tableblock.frame-topbot, table.tableblock.frame-none {
    border-left: 0;
    border-right: 0;
}

table.tableblock.frame-sides, table.tableblock.frame-none {
    border-top: 0;
    border-bottom: 0;
}

table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child {
    margin-bottom: 0;
}

th.tableblock.halign-left, td.tableblock.halign-left {
    text-align: left;
}

th.tableblock.halign-right, td.tableblock.halign-right {
    text-align: right;
}

th.tableblock.halign-center, td.tableblock.halign-center {
    text-align: center;
}

th.tableblock.valign-top, td.tableblock.valign-top {
    vertical-align: top;
}

th.tableblock.valign-bottom, td.tableblock.valign-bottom {
    vertical-align: bottom;
}

th.tableblock.valign-middle, td.tableblock.valign-middle {
    vertical-align: middle;
}

p.tableblock.header {
    color: var(--foreground-color);
    font-weight: bold;
}

td > div.verse {
    white-space: pre;
}

ol {
    margin-left: 0.25em;
}

ul li ol {
    margin-left: 0;
}

dl dd {
    margin-left: 1.125em;
}

dl dd:last-child, dl dd:last-child > :last-child {
    margin-bottom: 0;
}

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist {
    margin-bottom: 0.625em;
}

ul.unstyled, ol.unnumbered, ul.checklist, ul.none {
    list-style-type: none;
}

ul.unstyled, ol.unnumbered, ul.checklist {
    margin-left: 0.625em;
}

ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
    margin-right: 0.25em;
}

ul.checklist li > p:first-child > input[type="checkbox"]:first-child {
    position: relative;
    top: 1px;
}

ul.inline {
    margin: 0 auto 0.625em auto;
    margin-left: -1.375em;
    margin-right: 0;
    padding: 0;
    list-style: none;
    overflow: hidden;
}

ul.inline > li {
    list-style: none;
    float: left;
    margin-left: 1.375em;
    display: block;
}

ul.inline > li > * {
    display: block;
}

.unstyled dl dt {
    font-weight: normal;
    font-style: normal;
}

ol.arabic {
    list-style-type: decimal;
}

ol.decimal {
    list-style-type: decimal-leading-zero;
}

ol.loweralpha {
    list-style-type: lower-alpha;
}

ol.upperalpha {
    list-style-type: upper-alpha;
}

ol.lowerroman {
    list-style-type: lower-roman;
}

ol.upperroman {
    list-style-type: upper-roman;
}

ol.lowergreek {
    list-style-type: lower-greek;
}

.hdlist > table, .colist > table {
    border: 0;
    background: none;
}

.hdlist > table > tbody > tr, .colist > table > tbody > tr {
    background: none;
}

td.hdlist1 {
    padding-right: .8em;
    font-weight: bold;
}

td.hdlist1, td.hdlist2 {
    vertical-align: top;
}

.literalblock + .colist, .listingblock + .colist {
    margin-top: -0.5em;
}

.colist > table tr > td:first-of-type {
    padding: 0 .8em;
    line-height: 1;
}

.colist > table tr > td:last-of-type {
    padding: 0.25em 0;
}

.qanda > ol > li > p > em:only-child {
    color: var(--em-color);
}

.thumb, .th {
    line-height: 0;
    display: inline-block;
    border: solid 4px white;
    -webkit-box-shadow: 0 0 0 1px var(--border2);
    box-shadow: 0 0 0 1px var(--border2);
}

.imageblock.left, .imageblock[style*="float: left"] {
    margin: 0.25em 0.625em 1.25em 0;
}

.imageblock.right, .imageblock[style*="float: right"] {
    margin: 0.25em 0 1.25em 0.625em;
}

.imageblock > .title {
    margin-bottom: 0;
}

.imageblock.thumb, .imageblock.th {
    border-width: var(--border-radius-default);
}

.imageblock.thumb > .title, .imageblock.th > .title {
    padding: 0 0.125em;
}

.image.left, .image.right {
    margin-top: 0.25em;
    margin-bottom: 0.25em;
    display: inline-block;
    line-height: 0;
}

.image.left {
    margin-right: 0.625em;
}

.image.right {
    margin-left: 0.625em;
}

a.image {
    text-decoration: none;
}

span.footnote, span.footnoteref {
    vertical-align: super;
    font-size: 0.875em;
}

span.footnote a, span.footnoteref a {
    text-decoration: none;
}

#footnotes {
    padding-top: 0.75em;
    padding-bottom: 0.75em;
    margin-bottom: 0.625em;
}

#footnotes hr {
    width: 20%;
    min-width: 6.25em;
    margin: -.25em 0 .75em 0;
    border-width: 1px 0 0 0;
}

#footnotes .footnote {
    padding: 0 0.375em;
    line-height: 1.3;
    font-size: 0.875em;
    margin-left: 1.2em;
    text-indent: -1.2em;
    margin-bottom: .2em;
}

#footnotes .footnote a:first-of-type {
    font-weight: bold;
    text-decoration: none;
}

#footnotes .footnote:last-of-type {
    margin-bottom: 0;
}

#content #footnotes {
    margin-top: -0.625em;
    margin-bottom: 0;
    padding: 0.75em 0;
}

.gist .file-data > table {
    border: none;
    background: var(--background);
    width: 100%;
    margin-bottom: 0;
}

.gist .file-data > table td.line-data {
    width: 99%;
}

div.unbreakable {
    page-break-inside: avoid;
}

.big {
    font-size: larger;
}

.small {
    font-size: smaller;
}

.underline {
    text-decoration: underline;
}

.overline {
    text-decoration: overline;
}

.line-through {
    text-decoration: line-through;
}

.aqua {
    color: #00bfbf;
}

.aqua-background {
    background-color: #00fafa;
}

.black {
    color: black;
}

.black-background {
    background-color: black;
}

.blue {
    color: #0000bf;
}

.blue-background {
    background-color: #0000fa;
}

.fuchsia {
    color: #bf00bf;
}

.fuchsia-background {
    background-color: #fa00fa;
}

.gray {
    color: #606060;
}

.gray-background {
    background-color: #7d7d7d;
}

.green {
    color: #006000;
}

.green-background {
    background-color: #007d00;
}

.lime {
    color: #00bf00;
}

.lime-background {
    background-color: #00fa00;
}

.maroon {
    color: #600000;
}

.maroon-background {
    background-color: #7d0000;
}

.navy {
    color: #000060;
}

.navy-background {
    background-color: #00007d;
}

.olive {
    color: #606000;
}

.olive-background {
    background-color: #7d7d00;
}

.purple {
    color: #600060;
}

.purple-background {
    background-color: #7d007d;
}

.red {
    color: #bf0000;
}

.red-background {
    background-color: #fa0000;
}

.silver {
    color: #909090;
}

.silver-background {
    background-color: #bcbcbc;
}

.teal {
    color: #006060;
}

.teal-background {
    background-color: #007d7d;
}

.white {
    color: #bfbfbf;
}

.white-background {
    background-color: #fafafa;
}

.yellow {
    color: #bfbf00;
}

.yellow-background {
    background-color: #fafa00;
}

span.icon > [class^="icon-"], span.icon > [class*=" icon-"] {
    cursor: default;
}


.admonitionblock td.icon [class^="icon-"]:before {
    font-size: 2.5em;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    cursor: default;
}

.admonitionblock td.icon .icon-note:before {
    content: "\f05a";
    color: var(--accent-primary-color);
}

.admonitionblock td.icon .icon-tip:before {
    content: "\f0eb";
    /*text-shadow: 1px 1px 2px var(--accent-primary-color);*/
    color: var(--accent-primary-color);
}

.fa {
    font-family: "FontAwesome", "Helvetica Neue", sans-serif;
}

.admonitionblock td.icon .icon-warning:before {
    content: "\f071";
    color: #bf6900;
}

.admonitionblock td.icon .icon-caution:before {
    content: "\f06d";
    color: #bf3400;
}

.admonitionblock td.icon .icon-important:before {
    content: "\f06a";
    color: #bf0000;
}

.conum {
    display: inline-block;
    color: white !important;
    background-color: black;
    -webkit-border-radius: 100px;
    border-radius: 100px;
    text-align: center;
    width: 20px;
    height: 20px;
    font-size: 12px;
    font-weight: bold;
    line-height: 20px;
    font-family: Arial, sans-serif;
    font-style: normal;
    position: relative;
    top: -2px;
    letter-spacing: -1px;
}

.conum * {
    color: white !important;
}

.conum + b {
    display: none;
}

.conum:after {
    content: attr(data-value);
}

.conum:not([data-value]):empty {
    display: none;
}

h4 {
    color: var(--gray-color);
}

.literalblock > .content > pre, .listingblock > .content > pre {
    -webkit-border-radius: var(--border-radius-default);
    border-radius: var(--border-radius-default);
    margin-left: 0.5em;
    margin-right: 0.5em;
}

.admonitionblock {
    margin-left: .5em;
    margin-right: .5em;
}

.admonitionblock > table {
    border: 1px solid var(--accent-primary-color);
    border-left-width: 4px;
    background-color: var(--admotion-background-color);
    border-collapse: separate;
    -webkit-border-radius: var(--border-radius-default);
    border-radius: var(--border-radius-default);
}

.admonitionblock > table td.icon {
    padding-top: .5em;
    padding-bottom: .5em;
}

.admonitionblock > table td.content {
    padding: .5em .2em;
    color: black;
    font-size: .9em;
    border-left: none;
}

.sidebarblock {
    background-color: var(--sidebar-background-color);
    border-color: #ccc;
}

.sidebarblock > .content > .title {
    color: var(--link-color-default);
}

table.tableblock.grid-all {
    border-collapse: collapse;
    -webkit-border-radius: 0;
    border-radius: 0;
}

table.tableblock.grid-all th.tableblock, table.tableblock.grid-all td.tableblock {
    border-bottom: 1px solid #aaa;
}

#footer {
    background-color: var(--accent-primary-color);
    padding: 2em;
}

#footer-text {
    color: #eee;
    font-size: 0.8em;
    text-align: center;
}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #24292f;
  background-color: #f6f8fa;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kt, pre.rouge .kv {
  color: #cf222e;
}
pre.rouge .gr {
  color: #f6f8fa;
}
pre.rouge .gd {
  color: #82071e;
  background-color: #ffebe9;
}
pre.rouge .nb {
  color: #953800;
}
pre.rouge .nc {
  color: #953800;
}
pre.rouge .no {
  color: #953800;
}
pre.rouge .nn {
  color: #953800;
}
pre.rouge .sr {
  color: #116329;
}
pre.rouge .na {
  color: #116329;
}
pre.rouge .nt {
  color: #116329;
}
pre.rouge .gi {
  color: #116329;
  background-color: #dafbe1;
}
pre.rouge .ges {
  font-weight: bold;
  font-style: italic;
}
pre.rouge .kc {
  color: #0550ae;
}
pre.rouge .l, pre.rouge .ld, pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #0550ae;
}
pre.rouge .sb {
  color: #0550ae;
}
pre.rouge .bp {
  color: #0550ae;
}
pre.rouge .ne {
  color: #0550ae;
}
pre.rouge .nl {
  color: #0550ae;
}
pre.rouge .py {
  color: #0550ae;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #0550ae;
}
pre.rouge .o, pre.rouge .ow {
  color: #0550ae;
}
pre.rouge .gh {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .gu {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .se, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1, pre.rouge .ss {
  color: #0a3069;
}
pre.rouge .nd {
  color: #8250df;
}
pre.rouge .nf, pre.rouge .fm {
  color: #8250df;
}
pre.rouge .err {
  color: #f6f8fa;
  background-color: #82071e;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cp, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6e7781;
}
pre.rouge .gl {
  color: #6e7781;
}
pre.rouge .gt {
  color: #6e7781;
}
pre.rouge .ni {
  color: #24292f;
}
pre.rouge .si {
  color: #24292f;
}
pre.rouge .ge {
  color: #24292f;
  font-style: italic;
}
pre.rouge .gs {
  color: #24292f;
  font-weight: bold;
}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Music Store App</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_before_we_start">Before we start</a>
<ul class="sectlevel2">
<li><a href="#_mvvm_pattern">MVVM pattern</a></li>
<li><a href="#_messengers">Messengers</a></li>
</ul>
</li>
<li><a href="#_the_solution">The Solution</a>
<ul class="sectlevel2">
<li><a href="#_1_create_a_new_project">1, Create a New Project</a></li>
<li><a href="#_window_styling">Window Styling</a></li>
<li><a href="#_add_and_layout_controls">Add and Layout Controls</a></li>
<li><a href="#_button_command">Button Command</a></li>
<li><a href="#_open_a_dialog">Open a Dialog</a></li>
<li><a href="#_add_a_new_dialog_window">Add a New Dialog Window</a></li>
<li><a href="#_show_dialog">Show Dialog</a></li>
<li><a href="#_add_dialog_content">Add Dialog Content</a></li>
<li><a href="#_mock_search">Mock Search</a></li>
<li><a href="#_album_view">Album View</a></li>
<li><a href="#_album_service">Album Service</a></li>
<li><a href="#_displaying_images">Displaying Images</a></li>
<li><a href="#_dialog_return">Dialog Return</a></li>
<li><a href="#_add_items_to_the_users_collection">Add Items to the User&#8217;s Collection</a></li>
<li><a href="#_add_data_persistence">Add Data Persistence</a></li>
<li><a href="#_load_data_at_start_up">Load Data at Start-up</a></li>
<li><a href="#_conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial you will create a desktop app based on the idea of a music store. The app is highly graphical - it presents images of album covers, and uses semi-transparent 'acrylic' blurred window backgrounds to give a very up-to-date look. By the end of the tutorial, you will be able search the iTunes online list of albums, and select albums for your own list.</p>
</div>
<div id="final_result" class="imageblock">
<div class="content">
<img src="_docs/initial_preview.png" alt="This is how the final App should look like">
</div>
<div class="title">Figure 1. This is how the final App should look like</div>
</div>
<!-- toc disabled -->
<h3 id="_difficulty" class="discrete">Difficulty</h3>
<div class="paragraph">
<p>üê• Easy üê•</p>
</div>
<h3 id="_buzz_words" class="discrete">Buzz-Words</h3>
<div class="paragraph">
<p>Music Store, Complete App, CommunityToolkit.MVVM, Mvvm.Messaging, Styles, ObservableProperty, Commands, iTunes Api</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_we_start">Before we start</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this tutorial you will learn how to use the MVVM pattern with the <a href="https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/">[MVVM community toolkit]</a> to manage multiple application windows. Also you will use advanced asynchronous techniques to implement the album search and other features, so that application responsiveness is maintained.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is a more advanced tutorial. The 'To Do List App' is a recommended prerequisite if you have limited experience with the MVVM pattern. Read about the 'To Do List App' tutorial <a href="../../CompleteApps/SimpleToDoList">[here]</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For information and background on the concept of the MVVM pattern, see <a href="https://docs.avaloniaui.net/docs/concepts/the-mvvm-pattern/">[here]</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This sample assumes that you have a basic knowledge about the following topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some basics about C# and <a href="https://docs.avaloniaui.net/docs/get-started/test-drive/">[XAML]</a></p>
</li>
<li>
<p>What the <a href="../../MVVM/BasicMvvmSample">[MVVM -pattern]</a> (Model-View-ViewModel) is and how it works</p>
</li>
<li>
<p>What a <a href="../../MVVM/CommandSample">[Command]</a> is and how it works</p>
</li>
<li>
<p>What a <a href="https://learn.microsoft.com/en-us/dotnet/api/system.collections.objectmodel.observablecollection-1?view=net-8.0">[ObservableCollection]</a> is and how it works</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Some sections are optional. You can skip these if you want to.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_mvvm_pattern">MVVM pattern</h3>
<div class="paragraph">
<p>For information and background on the concept of the MVVM pattern, refer to the official documentation <a href="https://docs.avaloniaui.net/docs/concepts/the-mvvm-pattern/">[here]</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_messengers">Messengers</h3>
<div class="paragraph">
<p>This tutorial uses the messaging features of the CommunityToolkit.Mvvm to manage communication between view models and views. This is one approach to share data between different classes, without "knowing each other". If you are not familiar with it, you can read about it in the official documentation <a href="https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/messenger">[here]</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_solution">The Solution</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_1_create_a_new_project">1, Create a New Project</h3>
<div class="paragraph">
<p>Before you can start programming, you will have to create a new project for the app. Please see the <a href="https://docs.avaloniaui.net/docs/get-started/">[getting started guide]</a> if you need help installing Avalonia and setting up your IDE.</p>
</div>
<div class="paragraph">
<p>Most IDEs have templates for creating new Avalonia projects. In this tutorial you will use the 'Avalonia MVVM Application' template, which is available in both <em>Visual Studio</em> and <em>JetBrains Rider</em>. Make sure you have selected the <em>CommunityToolkit.Mvvm</em> option when creating the project.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you have <em>ReactiveUI</em> installed, you can uninstall this and install <em>CommunityToolkit.Mvvm</em> instead. Make sure to also update your usages.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A new project will be created with the following solution folders and files:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/2_rider_proj_structure.png" alt="This is the structure of the creates project">
</div>
<div class="title">Figure 2. The basic structure of the created project</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The file names may differ a little. For example "MainViewModel.cs" may be named "MainViewModel.cs" depending on the IDE you are using.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_update_project_dependencies_if_needed">Update Project Dependencies if needed</h4>
<div class="paragraph">
<p>Let&#8217;s make sure you use correct version of CommunityToolkit.Mvvm:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate project file Avalonia.MusicStore.csproj</p>
</li>
<li>
<p>Right-click on the project name in the Solution Explorer.</p>
</li>
<li>
<p>Select 'Edit' &#8594; 'Edit Avalonia.MusicStore.csproj'</p>
</li>
</ul>
</div>
<div id="prepare-project-for-partial-properties" class="paragraph">
<p>In the opened .csproj file, ensure you have the correct CommunityToolkit.Mvvm package version no older than 8.4.0 and
Avalonia version no older than 11.3.0.</p>
</div>
<div class="listingblock">
<div class="title">Update nuget packages</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;PackageReference</span> <span class="na">Include=</span><span class="s">"Avalonia"</span> <span class="na">Version=</span><span class="s">"11.3.0"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;PackageReference</span> <span class="na">Include=</span><span class="s">"Avalonia.Desktop"</span> <span class="na">Version=</span><span class="s">"11.3.0"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;PackageReference</span> <span class="na">Include=</span><span class="s">"Avalonia.Themes.Fluent"</span> <span class="na">Version=</span><span class="s">"11.3.0"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;PackageReference</span> <span class="na">Include=</span><span class="s">"CommunityToolkit.Mvvm"</span> <span class="na">Version=</span><span class="s">"8.4.0"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the same file enable preview C# language features:</p>
</div>
<div class="listingblock">
<div class="title">Within the <em>PropertyGroup</em> section, add the following line:</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;LangVersion&gt;</span>preview<span class="nt">&lt;/LangVersion&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This setting enables support for the latest C# features required by this tutorial, including partial properties introduced in C# 13.</p>
</div>
<div class="paragraph">
<p>Now take some time to review the files and folders that the solution template created. You will see that the following the MVVM pattern, these folders were created:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Folder Name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Assets</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contains any embedded assets that are compiled into the program. <code>Images</code>, <code>Icons</code>, <code>Fonts</code> etc, anything that the UI
Folder Name	Description
might need to display,</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Models</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is an empty folder for code that is the 'model' part of the MVVM pattern. This often contains everything else the app needs that is not part of the UI. For example: interaction with a database, Web API, or  interfaces with a hardware device.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">View Models</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is a folder for all the view models in the project, and it already contains an example. View models contain the application logic in the MVVM pattern. For example: a button is enabled only when the user has typed something; or open a dialog when the user clicks here; or show an error if the user enters too high a number type of logic in this input.</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Views</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is a folder for all the views in the project, and it already contains the view for the application main window. Views in the MVVM pattern contain only the presentation for the application; that is layout and form, fonts, colors, icons and images. In MVVM they have only enough code to link them to the view model layer. In <em>Avalonia UI</em> there is only enough code to manage windows and dialogs here.</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
To explore the concepts behind the MVVM pattern, and when is appropriate to use it, see <a href="https://docs.avaloniaui.net/docs/concepts/the-mvvm-pattern/">[Avalonia-docs]</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The solution template has created enough files for the application to run. You will meet all of these during the rest of this tutorial.</p>
</div>
</div>
<div class="sect3">
<h4 id="_run_the_project">Run the Project</h4>
<div class="paragraph">
<p>Press the debug button in your IDE to compile and run the project.</p>
</div>
<div class="paragraph">
<p>This will show a window that looks like:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/5_first_run.png" alt="First run">
</div>
<div class="title">Figure 3. first run of the created project</div>
</div>
<div class="paragraph">
<p>It is a little plain - but you now have a running application, and a blank canvas to start developing with.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_window_styling">Window Styling</h3>
<div class="paragraph">
<p>Now, you will make the main window look modern by applying a dark theme, and an acrylic blur to the window background.</p>
</div>
<div class="sect3">
<h4 id="_dark_mode">Dark Mode</h4>
<div class="paragraph">
<p>Follow this procedure to style the main window in 'dark' mode:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>Locate and open the file <strong>App.axaml</strong>.</p>
</li>
<li>
<p>In the XAML, change the <code>RequestedThemeVariant</code> attribute in the <code>&lt;Application&gt;</code> element from "Default" to "Dark"</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Application</span> <span class="err">...</span>
    <span class="na">RequestedThemeVariant=</span><span class="s">"Dark"</span><span class="nt">&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Now locate and open the <strong>MainWindow.axaml</strong> file in the <strong>/Views</strong> folder.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notice that the preview pane is still showing the window in 'light' mode. The application will require a rebuild for the new mode to show in the preview pane.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Click <strong>Build Startup Project</strong> on the <strong>Build</strong> menu.</p>
<div class="paragraph">
<p>The preview pane now changes to the dark mode.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_docs/6_DarkMode.png" alt="Previewer showing the dark mode"></span></p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_acrylic_blur">Acrylic Blur</h4>
<div class="paragraph">
<p>Follow this procedure to style the background of the main window with an acrylic blur:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MainWindow.axaml</strong> file in the <strong>/Views</strong> folder.</p>
</li>
<li>
<p>Find the end of the opening tag of the <code>&lt;Window&gt;</code> element.</p>
</li>
<li>
<p>After the <code>Title="Avalonia.MusicStore"</code> attribute, add two new attributes as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Window</span> <span class="err">...</span>
        <span class="na">Title=</span><span class="s">"Avalonia.MusicStore"</span>
        <span class="err">...</span>
        <span class="na">TransparencyLevelHint=</span><span class="s">"AcrylicBlur"</span>
        <span class="na">Background=</span><span class="s">"Transparent"</span><span class="nt">&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>To apply the acrylic effect to the whole window, replace the <code>&lt;TextBlock&gt;</code> element in the content zone of the main window with the following XAML for a panel:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Window</span> <span class="err">...</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;Panel&gt;</span>
        <span class="nt">&lt;ExperimentalAcrylicBorder</span> <span class="na">IsHitTestVisible=</span><span class="s">"False"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;ExperimentalAcrylicBorder.Material&gt;</span>
                <span class="nt">&lt;ExperimentalAcrylicMaterial</span>
                    <span class="na">BackgroundSource=</span><span class="s">"Digger"</span>
                    <span class="na">TintColor=</span><span class="s">"Black"</span>
                    <span class="na">TintOpacity=</span><span class="s">"1"</span>
                    <span class="na">MaterialOpacity=</span><span class="s">"0.65"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/ExperimentalAcrylicBorder.Material&gt;</span>
        <span class="nt">&lt;/ExperimentalAcrylicBorder&gt;</span>
    <span class="nt">&lt;/Panel&gt;</span>
<span class="nt">&lt;/Window&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
<div class="imageblock">
<div class="content">
<img src="_docs/7_AcrylicBlur.png" alt="Acrylic materia applied">
</div>
<div class="title">Figure 4. Acrylic materia applied</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notice that, as expected, the acrylic window effect covers the content zone of the main window. However the effect does not yet extend to the title bar.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Note that <em>Linux</em> users can not yet take advantage of the following code due to limitations of the X11 version. The tutorial code will run and the window will still work on <em>Linux</em>, but the full effect will not be realized.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Follow this procedure to extend the acrylic blur effect onto the title bar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if is still running.</p>
</li>
<li>
<p>Find the end of the opening tag of the <code>&lt;Window&gt;</code> element again.</p>
</li>
<li>
<p>Add the <code>ExtendClientAreaToDecorationsHint</code> attribute as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">   <span class="nt">&lt;Window</span> <span class="err">...</span>
           <span class="na">TransparencyLevelHint=</span><span class="s">"AcrylicBlur"</span>
           <span class="na">Background=</span><span class="s">"Transparent"</span>

           <span class="na">ExtendClientAreaToDecorationsHint=</span><span class="s">"True"</span><span class="nt">&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/8_FullAcrylicWindow.png" alt="Fully acrylic window">
</div>
<div class="title">Figure 5. Fully acrylic window</div>
</div>
<div class="paragraph">
<p>Now you have the acrylic blur effect extending into the title bar.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_add_and_layout_controls">Add and Layout Controls</h3>
<div class="paragraph">
<p>The main window of the app will eventually show a list of album covers in the user&#8217;s collection, with a button at its top-right corner to allow the user to add a new album. The button will open a search dialog window to find new albums to add.</p>
</div>
<div class="paragraph">
<p>On this page you will learn how to layout the main window so that the button appears at its top-right corner, as required.</p>
</div>
<div class="sect3">
<h4 id="_button_layout">Button Layout</h4>
<div class="paragraph">
<p>To display a button in the content zone of the main window, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>Locate and open the <strong>MainWindow.axaml</strong> file.</p>
</li>
<li>
<p>Inside the panel element, add the following XAML for a button. The panel XAML should look like this:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Panel&gt;</span>
    <span class="nt">&lt;ExperimentalAcrylicBorder</span> <span class="na">IsHitTestVisible=</span><span class="s">"False"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ExperimentalAcrylicBorder.Material&gt;</span>
            <span class="nt">&lt;ExperimentalAcrylicMaterial</span>
                 <span class="na">BackgroundSource=</span><span class="s">"Digger"</span>
                 <span class="na">TintColor=</span><span class="s">"Black"</span>
                 <span class="na">TintOpacity=</span><span class="s">"1"</span>
                 <span class="na">MaterialOpacity=</span><span class="s">"0.65"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/ExperimentalAcrylicBorder.Material&gt;</span>
     <span class="nt">&lt;/ExperimentalAcrylicBorder&gt;</span>

     <span class="nt">&lt;Button</span> <span class="na">Content=</span><span class="s">"Buy Music"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Panel&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
<div class="imageblock">
<div class="content">
<img src="_docs/9_Button_added_but_wrong_location.png" alt="Added the button to buy new music.">
</div>
<div class="title">Figure 6. Added button but wrong location</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will see the button, but it is in the default position and not at the top-right of the window as required.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to position the button correctly:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running</p>
</li>
<li>
<p>Wrap the button element in a new panel element.</p>
</li>
<li>
<p>Add a margin attribute to the new panel element, with a value of 40.</p>
</li>
<li>
<p>Add horizontal and vertical alignment attributes to the button element, as shown:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Panel</span> <span class="na">Margin=</span><span class="s">"40"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;Button</span> <span class="na">Content=</span><span class="s">"Buy Music"</span>
          <span class="na">HorizontalAlignment=</span><span class="s">"Right"</span> <span class="na">VerticalAlignment=</span><span class="s">"Top"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Panel&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see all these changes reflected in the preview pane as you add them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_button_icon">Button Icon</h4>
<div class="paragraph">
<p>Have a look back at the image of the <a href="#final_result">finished app</a>. You will see that the button shows an icon, and not text (as it currently does). This is actually the Microsoft Store icon from the Fluent Icons collection, and <em>Avalonia UI</em> has definitions for all these for you to use.</p>
</div>
<div class="paragraph">
<p>To use the Microsoft Store icon, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Navigate to the <em>Avalonia UI</em> <em>GitHub</em> to find the list of Fluent Icons at <a href="https://avaloniaui.github.io/icons.html" class="bare">https://avaloniaui.github.io/icons.html</a></p>
</li>
<li>
<p>Use your browser&#8217;s text search to locate the name of the icon 'store\_microsoft\_regular'. There should be some code similar to:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;StreamGeometry</span> <span class="na">x:Key=</span><span class="s">"store_microsoft_regular"</span><span class="nt">&gt;</span>M11.5 9.5V13H8V9.5H11.5Z M11.5 17.5V14H8V17.5H11.5Z M16 9.5V13H12.5V9.5H16Z M16 17.5V14H12.5V17.5H16Z M8 6V3.75C8 2.7835 8.7835 2 9.75 2H14.25C15.2165 2 16 2.7835 16 3.75V6H21.25C21.6642 6 22 6.33579 22 6.75V18.25C22 19.7688 20.7688 21 19.25 21H4.75C3.23122 21 2 19.7688 2 18.25V6.75C2 6.33579 2.33579 6 2.75 6H8ZM9.5 3.75V6H14.5V3.75C14.5 3.61193 14.3881 3.5 14.25 3.5H9.75C9.61193 3.5 9.5 3.61193 9.5 3.75ZM3.5 18.25C3.5 18.9404 4.05964 19.5 4.75 19.5H19.25C19.9404 19.5 20.5 18.9404 20.5 18.25V7.5H3.5V18.25Z<span class="nt">&lt;/StreamGeometry&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Copy all of the code for the icon.</p>
</li>
<li>
<p>In the solution explorer, right-click the project.</p>
</li>
<li>
<p>Click <strong>Add</strong>, then click  <strong>Avalonia Resources</strong></p>
</li>
<li>
<p>Enter the <strong>Name</strong> 'Icons', press enter.</p>
</li>
<li>
<p>Locate and open the new <strong>Icons.axaml</strong> file that is created. The XAML will look like this:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ResourceDictionary</span> <span class="na">xmlns=</span><span class="s">"https://github.com/avaloniaui"</span>
                    <span class="na">xmlns:x=</span><span class="s">"http://schemas.microsoft.com/winfx/2006/xaml"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Design.PreviewWith&gt;</span>
        <span class="c">&lt;!-- Here we can add some controls for the previewer --&gt;</span>
    <span class="nt">&lt;/Design.PreviewWith&gt;</span>

    <span class="c">&lt;!-- Add the resources here. --&gt;</span>

<span class="nt">&lt;/ResourceDictionary&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Paste your icon code inside the <code>&lt;ResourceDictionary&gt;</code>.</p>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Remember that each node needs the <code>x:Key</code> provided.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The icons file now looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ResourceDictionary</span> <span class="na">xmlns=</span><span class="s">"https://github.com/avaloniaui"</span>
                    <span class="na">xmlns:x=</span><span class="s">"http://schemas.microsoft.com/winfx/2006/xaml"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Design.PreviewWith&gt;</span>
        <span class="nt">&lt;Border</span> <span class="na">Padding=</span><span class="s">"20"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;StackPanel</span> <span class="na">Spacing=</span><span class="s">"5"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;PathIcon</span> <span class="na">Data=</span><span class="s">"{StaticResource store_microsoft_regular}"</span><span class="nt">&gt;&lt;/PathIcon&gt;</span>
                <span class="nt">&lt;PathIcon</span> <span class="na">Data=</span><span class="s">"{StaticResource music_regular}"</span><span class="nt">&gt;&lt;/PathIcon&gt;</span>
            <span class="nt">&lt;/StackPanel&gt;</span>
        <span class="nt">&lt;/Border&gt;</span>
    <span class="nt">&lt;/Design.PreviewWith&gt;</span>

    <span class="nt">&lt;StreamGeometry</span> <span class="na">x:Key=</span><span class="s">"store_microsoft_regular"</span><span class="nt">&gt;</span> [ ... Add the path data here ... ] <span class="nt">&lt;/StreamGeometry&gt;</span>
    <span class="nt">&lt;StreamGeometry</span> <span class="na">x:Key=</span><span class="s">"music_regular"</span><span class="nt">&gt;</span> [ ... Add the path data here ... ] <span class="nt">&lt;/StreamGeometry&gt;</span>

<span class="nt">&lt;/ResourceDictionary&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Most of the time the path can be also extracted from any svg-path.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With a new icons file prepared, you must now include it in your app.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to include the icons file:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>App.axaml</strong> file.</p>
</li>
<li>
<p>Add a <code>&lt;ResourceDictionary&gt;</code> element with a <code>&lt;ResourceInclude&gt;</code> as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Application.Resources&gt;</span>
    <span class="nt">&lt;ResourceDictionary&gt;</span>
        <span class="nt">&lt;ResourceDictionary.MergedDictionaries&gt;</span>
            <span class="nt">&lt;ResourceInclude</span> <span class="na">Source=</span><span class="s">"avares://Avalonia.MusicStore/Icons.axaml"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/ResourceDictionary.MergedDictionaries&gt;</span>
    <span class="nt">&lt;/ResourceDictionary&gt;</span>
<span class="nt">&lt;/Application.Resources&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>You need to build the application so that the icons become available to the preview pane.</p>
</div>
<div class="paragraph">
<p>To change the button from text to icon content, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MainWindow.axaml</strong> file.</p>
</li>
<li>
<p>Alter the XAML for the button, as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Button</span> <span class="na">HorizontalAlignment=</span><span class="s">"Right"</span> <span class="na">VerticalAlignment=</span><span class="s">"Top"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;PathIcon</span> <span class="na">Data=</span><span class="s">"{StaticResource store_microsoft_regular}"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/Button&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
<div class="imageblock">
<div class="content">
<img src="_docs/10_Button_with_icon.png" alt="Button with icon">
</div>
<div class="title">Figure 7. The button now has an icon</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_button_command">Button Command</h3>
<div class="paragraph">
<p>So far in this tutorial, you have altered only files from the view part of the MVVM pattern (for the main window and app). In this section you will learn how to link the button in the view for the main window, to a command in the view model. This will cause user interaction with the view (in this case a button click) to have an effect in the application logic of the view model.</p>
</div>
<div class="paragraph">
<p>When you develop with <em>Avalonia UI</em> and the MVVM pattern, the solution template will give you a choice of MVVM toolkits. This tutorial now uses <em>CommunityToolkit.Mvvm</em>, and the solution template has already added the necessary packages.</p>
</div>
<div class="sect3">
<h4 id="_relaycommand">RelayCommand</h4>
<div class="paragraph">
<p>The first step in linking the view and view model is to make the view model able to accept a command. You will achieve this by adding a method to the main window view model and decorating it with the <code>[RelayCommand]</code> attribute, which will generate a bindable <code>ICommand</code> property, which can be referenced from your view.
Follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>Locate and open the <strong>MainViewModel.cs</strong> file in the <strong>/ViewModels</strong> folder.</p>
</li>
<li>
<p>Delete the existing content of the class, and add the code shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.Input</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Avalonia.MusicStore.ViewModels</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">MainViewModel</span> <span class="p">:</span> <span class="n">ObservableObject</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">MainViewModel</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// ViewModel initialization logic.</span>
        <span class="p">}</span>

        <span class="p">[</span><span class="n">RelayCommand</span><span class="p">]</span>
        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddAlbumAsync</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// Code here will be executed when the button is clicked.</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_how_it_works">How it works</h4>
<div class="paragraph">
<p>The <code>[RelayCommand]</code> attribute generates a public property for you at compile time named <code>AddAlbumCommand</code>, which implements <code>ICommand</code>.</p>
</div>
<div class="paragraph">
<p>This means that even though you only wrote a method named <code>AddAlbumAsync</code>, Avalonia&#8217;s data-binding system can bind directly to <code>AddAlbumCommand</code> in your AXAML ‚Äî without you writing any boilerplate command logic.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to see how this method is executes, you can place a debug breakpoint at the opening curly brace inside the <code>AddAlbumAsync()</code> method.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To complete the link from the view to your new <code>AddAlbumAsync</code> view model property, you will add a data binding to the button.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information about the concept of data binding, see <a href="https://docs.avaloniaui.net/docs/basics/data/data-binding">[here]</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To add the button data binding, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MainWindow.axaml</strong> file.</p>
</li>
<li>
<p>Find the XAML for the button and add the command attribute and binding, as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Button</span> <span class="na">HorizontalAlignment=</span><span class="s">"Right"</span> <span class="na">VerticalAlignment=</span><span class="s">"Top"</span>
        <span class="na">Command=</span><span class="s">"{Binding AddAlbumCommand}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;PathIcon</span> <span class="na">Data=</span><span class="s">"{StaticResource store_microsoft_regular}"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Button&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_why_it_is_addalbumcommand">Why it is <code>AddAlbumCommand</code>?</h4>
<div class="paragraph">
<p>The <code>[RelayCommand]</code> attribute automatically generates command properties based on your method names. If your method name ends with <em>Async</em>, the generator removes the <em>Async</em> suffix and appends <em>Command</em> to form the property name.
If the method returns a Task, <code>[RelayCommand]</code> automatically generates an <code>IAsyncRelayCommand</code> instead of a regular <code>IRelayCommand</code>, giving you full support for asynchronous execution.
This means:
- If your method is named <code>AddAlbumAsync</code>, the generated property will be called <code>AddAlbumCommand</code>.
- If your method is named <code>AddAlbum</code>, it also becomes <code>AddAlbumCommand</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Learn more about asynchronous <code>RelayCommand</code> generation in <a href="https://learn.microsoft.com/en-us/dotnet/communitytoolkit/mvvm/generators/relaycommand#asynchronous-commands">[the official docs]</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>Command</code> property of an <em>Avalonia UI</em> button determines what happens when the button is clicked. In this case it binds to the <code>AddAlbumCommand</code> generated in your view model, causing the <code>AddAlbumAsync</code> method to run.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will see the app stop executing at the breakpoint you previously set in the view model.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_open_a_dialog">Open a Dialog</h3>
<div class="paragraph">
<p>On this page you will learn how to open dialog window in your app and exchange data between windows using Mvvm.Messaging. The dialog will be used to search for and select an album to add to a list in the main window.</p>
</div>
<div class="paragraph">
<p>Several messages will be used in your app:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">PurchaseAlbumMessage</dt>
<dd>
<p>sent by the main view model to request the dialog window be shown and await a result.</p>
</dd>
<dt class="hdlist1">MusicStoreClosedMessage</dt>
<dd>
<p>sent by the dialog&#8217;s view model when the user selects an album, to return the result and close the dialog.</p>
</dd>
<dt class="hdlist1">CheckAlbumAlreadyExistsMessage</dt>
<dd>
<p>sent by the dialog&#8217;s view model before sending the <code>MusicStoreClosedMessage</code> to the main view model in order to make sure the album is not yet present. This part is optional</p>
</dd>
<dt class="hdlist1">NotificationMessage</dt>
<dd>
<p>sent by the main view model to display a notification, for example when an album was bought successfully. This part is optional.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Below is a stripped down diagram showing the message flow between the components that you are going to implement in the next steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="mermaid">graph TD;
    A[MainViewModel] --&gt;|Send PurchaseAlbumMessage| B(MainWindow)
    B --&gt;|Show MusicStoreWindow&lt;br&gt;await AlbumViewModel| C[MusicStoreWindow]
    C --&gt;|BuyMusic| D[MusicStoreViewModel]
    D --&gt;|Send MusicStoreClosedMessage&lt;br&gt;with SelectedAlbum| C
    C --&gt;|Close dialog&lt;br&gt;return SelectedAlbum| B
    B --&gt;|Reply with AlbumViewModel| A</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The diagram above is simplified to show the basic message flow. In the actual implementation, there are additional message exchanges for checking if an album already exists and for displaying notifications.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_add_a_new_dialog_window">Add a New Dialog Window</h3>
<div class="paragraph">
<p>There is nothing special about a window view file that makes it into a dialog; that is up to the way in which the window is controlled by the app. You will use Avalonia UI features and <em>CommunityToolkit.Mvvm</em> to manage this. So the first step is to create a new window for the app.</p>
</div>
<div class="paragraph">
<p>To create a new window, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>In the solution explorer, right-click the <strong>/Views</strong> folder and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Click <strong>Avalonia Window</strong>.</p>
</li>
<li>
<p>When prompted for the name, type 'MusicStoreWindow'</p>
</li>
<li>
<p>Press enter.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_dialog_window_styling">Dialog Window Styling</h4>
<div class="paragraph">
<p>To style the new dialog window so that it matches the main window, follow the same procedure as explain in the section "<a href="#_acrylic_blur">Acrylic Blur</a>" for the main window.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dialog_input_and_output">Dialog Input and Output</h4>
<div class="paragraph">
<p>The application logic for the dialog will be controlled by its own view model. This will be created and linked to the dialog window view whenever the dialog is to be shown.</p>
</div>
<div class="paragraph">
<p>Similarly, the result of the users interaction with the dialog will eventually have to be passed back to the application logic for the main window for processing.</p>
</div>
<div class="paragraph">
<p>At this stage you will create two empty view model classes to act as placeholders for the dialog view model, and the dialog return (selected album) object. To create these view models, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the solution explorer, right-click the <strong>/ViewModels</strong> folder and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Click <strong>Class</strong>.</p>
</li>
<li>
<p>Name the class 'MusicStoreViewModel' and click <strong>Add</strong>.</p>
</li>
<li>
<p>Right-click again the <strong>/ViewModels</strong> folder and then click <strong>Add</strong> a second time.</p>
</li>
<li>
<p>Click <strong>Class</strong>.</p>
</li>
<li>
<p>Name the class 'AlbumViewModel' and click <strong>Add</strong>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_show_dialog">Show Dialog</h3>
<div class="paragraph">
<p>Now that you have a new window <code>MusicStoreWindow</code> and the corresponding view models <code>MusicStoreViewModel</code> and <code>AlbumViewModel</code>.
You are going to complete the logic so that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The main window view model sends a message requesting the dialog to be shown.</p>
</li>
<li>
<p>The main window view receives that message, opens the dialog, and returns the result.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Below is how this works step-by-step using the CommunityToolkit.Mvvm messaging API.</p>
</div>
<div class="sect3">
<h4 id="_define_the_purchasealbummessage">Define the PurchaseAlbumMessage</h4>
<div class="ulist">
<ul>
<li>
<p>In the project root directory create new folder <strong>/Messages</strong></p>
</li>
<li>
<p>In the newly created <strong>/Messages</strong> folder add a class <strong>PurchaseAlbumMessage</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First, you are going to define a message class called <code>PurchaseAlbumMessage</code> that carries an <code>AlbumViewModel</code> response.
This message will be sent by the view model when it needs to show the dialog.</p>
</div>
<div class="paragraph">
<p>Open <strong>PurchaseAlbumMessage.cs</strong> and add the following code there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">Avalonia.MusicStore.ViewModels</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.Messaging.Messages</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Avalonia.MusicStore.Messages</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">PurchaseAlbumMessage</span> <span class="p">:</span> <span class="n">AsyncRequestMessage</span><span class="p">&lt;</span><span class="n">AlbumViewModel</span><span class="p">?&gt;;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><em>`AsyncRequestMessage&lt;T&gt;`</em> lets you send a request and await a reply of type T (in our case, AlbumViewModel?).</p>
</div>
</div>
<div class="sect3">
<h4 id="_register_the_message_handler_in_mainwindow">Register the Message Handler in  MainWindow</h4>
<div class="paragraph">
<p>In <em>MainWindow.axaml.cs</em> register a handler for <code>PurchaseAlbumMessage</code>. This handler runs whenever the view model sends that message. Its job is to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create the dialog window.</p>
</li>
<li>
<p>Assign <code>MusicStoreViewModel</code> as its DataContext.</p>
</li>
<li>
<p>Call <code>ShowDialog&lt;AlbumViewModel?&gt;</code> and pass the result back via m.Reply(&#8230;&#8203;).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Open <em>MainWindow.axaml.cs</em> and add the following code into MainWindow constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="nf">MainWindow</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">InitializeComponent</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Design</span><span class="p">.</span><span class="n">IsDesignMode</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="c1">// Whenever 'Send(new PurchaseAlbumMessage())' is called, invoke this callback on the MainWindow instance:</span>
    <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">MainWindow</span><span class="p">,</span> <span class="n">PurchaseAlbumMessage</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">,</span> <span class="k">static</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// Create an instance of MusicStoreWindow and set MusicStoreViewModel as its DataContext.</span>
        <span class="kt">var</span> <span class="n">dialog</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MusicStoreWindow</span>
        <span class="p">{</span>
            <span class="n">DataContext</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MusicStoreViewModel</span><span class="p">()</span>
        <span class="p">};</span>
        <span class="c1">// Show dialog window and reply with returned AlbumViewModel or null when the dialog is closed.</span>
        <span class="n">m</span><span class="p">.</span><span class="nf">Reply</span><span class="p">(</span><span class="n">dialog</span><span class="p">.</span><span class="n">ShowDialog</span><span class="p">&lt;</span><span class="n">AlbumViewModel</span><span class="p">?&gt;(</span><span class="n">w</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_send_the_message_from_the_viewmodel">Send the Message from the ViewModel</h4>
<div class="paragraph">
<p>Now, update the <code>AddAlbumAsync()</code> method inside <code>MainViewModel</code> to send <code>PurchaseAlbumMessage</code> when the user clicks on the store button.
- Open <strong>MainViewModel.cs</strong>
- Locate the <code>AddAlbumAsync()</code> method that we added in the previous steps.
- Edit <code>AddAlbumAsync()</code> as shown:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="p">[</span><span class="n">RelayCommand</span><span class="p">]</span>
<span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddAlbumAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Send the message to the previously registered handler and await the selected album</span>
    <span class="kt">var</span> <span class="n">album</span> <span class="p">=</span> <span class="k">await</span> <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="k">new</span> <span class="nf">PurchaseAlbumMessage</span><span class="p">());</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now:
- Click <strong>Debug</strong> to compile and run the project.
- Click the icon button.</p>
</div>
<div class="paragraph">
<p>It all works - but the dialog window opens at the same size as the main window, and offset from it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dialog_position_and_size">Dialog Position and Size</h4>
<div class="paragraph">
<p>For the final tweak, you will make the dialog smaller than the main window, and open centered on it. You will also make the main window open in the center of the user&#8217;s screen.</p>
</div>
<div class="paragraph">
<p>Follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>Locate and open the <strong>MainWindow.axaml</strong> file.</p>
</li>
<li>
<p>Add an attribute to the <code>&lt;Window&gt;</code> element to set the start-up position:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Window</span> <span class="err">...</span>
    <span class="na">WindowStartupLocation=</span><span class="s">"CenterScreen"</span><span class="nt">&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreWindow.axaml</strong> file.</p>
</li>
<li>
<p>Add attributes for the width and height of the dialog, set at 1000 and 550 respectively.</p>
</li>
<li>
<p>Add the start-up position attribute set to <code>CenterOwner</code>, as shown:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Window</span> <span class="err">...</span>
    <span class="na">Width=</span><span class="s">"1000"</span> <span class="na">Height=</span><span class="s">"550"</span>
    <span class="na">WindowStartupLocation=</span><span class="s">"CenterOwner"</span><span class="nt">&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/12_opened_dialog.png" alt="dialog window open centered">
</div>
<div class="title">Figure 8. Dialog opened centered</div>
</div>
<div class="paragraph">
<p>The dialog window is now opened centered inside the main window.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_add_dialog_content">Add Dialog Content</h3>
<div class="paragraph">
<p>Now you will learn how to add some content to the dialog window. This will be some controls for the search and a dialog close button; together with a list of placeholders for the album covers - these will eventually be loaded as the results of the search.</p>
</div>
<div class="paragraph">
<p>To arrange the dialog controls, you will use the dock panel layout control, that is part of the <em>Avalonia UI</em> built-in controls. This will keep the search controls at the top of the dialog, and the button at the bottom, whatever the height. The list will be the 'fill' area of the dock panel, so it will always take up all the remaining content zone.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/13_search_album_dialog_sketch.png" alt="A sketch showing how the dialog window will be laid out">
</div>
<div class="title">Figure 9. A sketch of the dialog layout</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For full information on the dock panel control, see the reference <a href="https://docs.avaloniaui.net/docs/reference/controls/dockpanel">[here]</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The dock panel itself will be located on an <em>Avalonia UI</em> user control. This is so the code that shows the dialog can be separated from the code that operates the controls within the dialog.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a common pattern of UI Composition, to read about this concept, see <a href="https://docs.avaloniaui.net/docs/concepts/ui-composition">[here]</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Follow this procedure to add the user control and constituent controls for the dialog:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>In the solution explorer, right-click the <strong>/Views</strong> folder and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Click <strong>Avalonia User Control</strong>.</p>
</li>
<li>
<p>When prompted for the name, type 'MusicStoreView'.</p>
</li>
<li>
<p>Press enter.</p>
</li>
<li>
<p>Alter the XAML for the user control&#8217;s content zone as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;UserControl</span> <span class="err">...</span> <span class="nt">&gt;</span>
  <span class="nt">&lt;DockPanel&gt;</span>
    <span class="nt">&lt;StackPanel</span> <span class="na">DockPanel.Dock=</span><span class="s">"Top"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;TextBox</span> <span class="na">Watermark=</span><span class="s">"Search for Albums...."</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;ProgressBar</span> <span class="na">IsIndeterminate=</span><span class="s">"True"</span>  <span class="nt">/&gt;</span>
    <span class="nt">&lt;/StackPanel&gt;</span>
      <span class="nt">&lt;Button</span> <span class="na">Content=</span><span class="s">"Buy Album"</span>
              <span class="na">DockPanel.Dock=</span><span class="s">"Bottom"</span>
              <span class="na">HorizontalAlignment=</span><span class="s">"Center"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;ListBox/&gt;</span>
  <span class="nt">&lt;/DockPanel&gt;</span>
<span class="nt">&lt;/UserControl&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Inside the dialog the user will be able to search for albums, but this will use a Web API, and may take some time to return. It is for this reason that you have added a progress bar. The progress bar will be active during the search - to provide visual feedback to the user.</p>
</div>
<div class="paragraph">
<p>Also, to ensure that the app remains responsive during the search, you will implement the operation itself as both asynchronous and cancellable. You will add this functionality later in the tutorial.</p>
</div>
<div class="paragraph">
<p>Now the next step is for you to add the new user control to the content zone of the dialog window.</p>
</div>
<div class="paragraph">
<p>To add the user control, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreWindow.axaml</strong> file.</p>
</li>
<li>
<p>Add the namespace for the views to the <code>&lt;Window&gt;</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Window</span> <span class="err">...</span>
        <span class="na">xmlns:views=</span><span class="s">"using:Avalonia.MusicStore.Views"</span> <span class="nt">&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Inside the panel element, add an element for new user control and a <a href="https://api-docs.avaloniaui.net/docs/T_Avalonia_Controls_Notifications_WindowNotificationManager">[NotificationManager]</a> to show notifications to the user:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Panel</span> <span class="na">Margin=</span><span class="s">"40"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;views:MusicStoreView/&gt;</span>
<span class="nt">&lt;/Panel&gt;</span>
<span class="nt">&lt;WindowNotificationManager</span> <span class="na">x:Name=</span><span class="s">"NotificationManager"</span>
                           <span class="na">Position=</span><span class="s">"TopRight"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We will use the notification manager later in the tutorial to show messages to the user. To access it from code behind, give it the name <code>NotificationManager</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You will see the controls appear in the preview pane.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mock_search">Mock Search</h3>
<div class="paragraph">
<p>In this section you will create the view model for the album search feature, and then bind it to the controls on the new user control. At this stage you will use a mock of the search itself, so that you can concentrate on the view model.</p>
</div>
<div class="sect3">
<h4 id="_mvvm_toolkit_view_model">MVVM Toolkit View Model</h4>
<div class="paragraph">
<p>The <em>CommunityToolkit.Mvvm</em> framework provides <em>Avalonia UI</em> with support for its data binding system. You add this support by deriving your view model from the <code>ObservableObject</code> class, via the <code>ViewModelBase</code> class that was added to your project at the start, by the solution template.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to derive from the <code>ObservableObject</code> class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add the code to derive the class from <code>ViewModelBase</code> and make the class <code>partial</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">namespace</span> <span class="nn">Avalonia.MusicStore.ViewModels</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">MusicStoreViewModel</span> <span class="p">:</span> <span class="n">ViewModelBase</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This setup allows you to use attributes like <code>[ObservableProperty]</code>, which automatically generate backing fields and property change notifications needed for UI binding.</p>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can learn more about <code>[ObservableProperty]</code> and <code>INotifyPropertyChanged</code> <a href="https://docs.avaloniaui.net/docs/guides/data-binding/inotifypropertychanged">[here]</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this stage, you will create two properties for the search application logic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A text string that is the search criteria,</p>
</li>
<li>
<p>A Boolean that indicates whether the search is busy.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Add the following properties using the  <code>[ObservableProperty]</code> attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Avalonia.MusicStore.ViewModels</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">MusicStoreViewModel</span> <span class="p">:</span> <span class="n">ViewModelBase</span>
    <span class="p">{</span>
       <span class="p">[</span><span class="n">ObservableProperty</span><span class="p">]</span> <span class="k">public</span> <span class="k">partial</span> <span class="kt">string</span><span class="p">?</span> <span class="n">SearchText</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

       <span class="p">[</span><span class="n">ObservableProperty</span><span class="p">]</span> <span class="k">public</span> <span class="k">partial</span> <span class="kt">bool</span> <span class="n">IsBusy</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that the partial property syntax was introduced in C# 13 Community Toolkit 8.4, visit <a href="#prepare-project-for-partial-properties">Setup the project</a> for correct setup.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_data_binding">Data Binding</h4>
<div class="paragraph">
<p>Next you will add a data binding to link the view to the view model. The text box will be bound to the search text, and whether the progress bar is visible to the user will  be bound to the Boolean.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to add data binding to the view:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreView.axaml</strong> file.</p>
</li>
<li>
<p>Add the binding expressions shown:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;UserControl</span> <span class="err">...</span>
    <span class="na">xmlns:vm=</span><span class="s">"clr-namespace:Avalonia.MusicStore.ViewModels"</span>
    <span class="na">x:DataType=</span><span class="s">"vm:MusicStoreViewModel"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
    <span class="nt">&lt;DockPanel&gt;</span>
      <span class="nt">&lt;StackPanel</span> <span class="na">DockPanel.Dock=</span><span class="s">"Top"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;TextBox</span> <span class="na">Watermark=</span><span class="s">"Search for Albums...."</span> <span class="na">Text=</span><span class="s">"{Binding SearchText}"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;ProgressBar</span> <span class="na">IsIndeterminate=</span><span class="s">"True"</span> <span class="na">IsVisible=</span><span class="s">"{Binding IsBusy}"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/StackPanel&gt;</span>
      <span class="nt">&lt;Button</span> <span class="na">Content=</span><span class="s">"Buy Album"</span>
              <span class="na">DockPanel.Dock=</span><span class="s">"Bottom"</span>
              <span class="na">HorizontalAlignment=</span><span class="s">"Center"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;ListBox/&gt;</span>
    <span class="nt">&lt;/DockPanel&gt;</span>
    <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/UserControl&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_album_search_and_selection">Album Search and Selection</h4>
<div class="paragraph">
<p>Your next step is to create the music store view model properties needed to process albums. These are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a collection of album view models to represent the albums that the search might find,</p>
</li>
<li>
<p>and a property to hold an album if the user selects one.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here you will use the <code>ObservableCollection</code> - this is a collection is capable of notification, and it is provided by the .NET framework.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to add the above properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add the following code to the class:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="p">[</span><span class="n">ObservableProperty</span><span class="p">]</span> <span class="k">public</span> <span class="k">partial</span> <span class="n">AlbumViewModel</span><span class="p">?</span> <span class="n">SelectedAlbum</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="k">public</span> <span class="n">ObservableCollection</span><span class="p">&lt;</span><span class="n">AlbumViewModel</span><span class="p">&gt;</span> <span class="n">SearchResults</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Next to bind these properties to the list box in the view, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreView.axaml</strong> file.</p>
</li>
<li>
<p>Add the binding expressions shown to the <code>&lt;ListBox&gt;</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ListBox</span> <span class="na">ItemsSource=</span><span class="s">"{Binding SearchResults}"</span> <span class="na">SelectedItem=</span><span class="s">"{Binding SelectedAlbum}"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_mock_data">Mock Data</h4>
<div class="paragraph">
<p>Now, to test the app at this stage, you will add some mock data directly to the view model.</p>
</div>
<div class="paragraph">
<p>Follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreViewModel.cs</strong> file again.</p>
</li>
<li>
<p>Add a constructor to the class, as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="nf">MusicStoreViewModel</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">());</span>
    <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">());</span>
    <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">());</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
<div class="imageblock">
<div class="content">
<img src="_docs/14_mock_search_preview.png" alt="Mock search preview">
</div>
<div class="title">Figure 10. Preview of the mock-up search results</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>This shows that the data binding from the list to the album collection in the view model is working, but the view is not graphical yet.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_album_view">Album View</h3>
<div class="paragraph">
<p>In this paragraph you will continue developing the search results list for the app by replacing the text currently shown with graphical album tiles.</p>
</div>
<div class="sect3">
<h4 id="_icon_resource">Icon Resource</h4>
<div class="paragraph">
<p>The first step here is to add a resource for the 'music note' icon. You will use this to act as a placeholder icon for the album covers in the app - they will eventually be replaced by the downloaded album cover artwork.</p>
</div>
<div class="paragraph">
<p>To add the music note icon resource, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>Navigate to the <em>Avalonia UI</em> <em>GitHub</em> to find the list of Fluent Icons at <a href="https://avaloniaui.github.io/icons.html" class="bare">https://avaloniaui.github.io/icons.html</a></p>
</li>
<li>
<p>Use your browser&#8217;s text search to locate the name of the icon 'music_regular'. There should be some code similar to:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;StreamGeometry</span> <span class="na">x:Key=</span><span class="s">"music_regular"</span><span class="nt">&gt;</span>M11.5,2.75 C11.5,2.22634895 12.0230228,1.86388952 12.5133347,2.04775015 L18.8913911,4.43943933 C20.1598961,4.91511241 21.0002742,6.1277638 21.0002742,7.48252202 L21.0002742,10.7513533 C21.0002742,11.2750044 20.4772513,11.6374638 19.9869395,11.4536032 L13,8.83332147 L13,17.5 C13,17.5545945 12.9941667,17.6078265 12.9830895,17.6591069 C12.9940859,17.7709636 13,17.884807 13,18 C13,20.2596863 10.7242052,22 8,22 C5.27579485,22 3,20.2596863 3,18 C3,15.7403137 5.27579485,14 8,14 C9.3521238,14 10.5937815,14.428727 11.5015337,15.1368931 L11.5,2.75 Z M8,15.5 C6.02978478,15.5 4.5,16.6698354 4.5,18 C4.5,19.3301646 6.02978478,20.5 8,20.5 C9.97021522,20.5 11.5,19.3301646 11.5,18 C11.5,16.6698354 9.97021522,15.5 8,15.5 Z M13,3.83223733 L13,7.23159672 L19.5002742,9.669116 L19.5002742,7.48252202 C19.5002742,6.75303682 19.0477629,6.10007069 18.3647217,5.84393903 L13,3.83223733 Z<span class="nt">&lt;/StreamGeometry&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy all of the code for the icon.</p>
</li>
<li>
<p>Locate and open the <strong>Icons.axaml</strong> file that you created earlier (see: <a href="#_button_icon">Button Icon</a>).</p>
</li>
<li>
<p>Paste the copied`&lt;StreamGeometry&gt;` element inside <code>&lt;Resources&gt;</code> element.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_album_view_2">Album View</h4>
<div class="paragraph">
<p>The next step is to create a graphical 'tile' view for an album. You will then cause this to be used instead of the text that currently shows for each album in the list.</p>
</div>
<div class="paragraph">
<p>To create the graphical 'tile' view, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the solution explorer, right-click the <strong>/Views</strong> folder and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Click <strong>Avalonia User Control</strong>.</p>
</li>
<li>
<p>When prompted for the name, type 'AlbumView'.</p>
</li>
<li>
<p>Press enter.</p>
</li>
<li>
<p>Add the attribute <code>Width="200"</code> to the <code>&lt;UserControl&gt;</code> element.</p>
</li>
<li>
<p>Alter the XAML for the user control&#8217;s content zone as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;UserControl</span> <span class="na">xmlns=</span><span class="s">"https://github.com/avaloniaui"</span>
             <span class="na">xmlns:x=</span><span class="s">"http://schemas.microsoft.com/winfx/2006/xaml"</span>
             <span class="na">xmlns:d=</span><span class="s">"http://schemas.microsoft.com/expression/blend/2008"</span>
             <span class="na">xmlns:mc=</span><span class="s">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span>
             <span class="na">xmlns:vm=</span><span class="s">"using:Avalonia.MusicStore.ViewModels"</span>
             <span class="na">mc:Ignorable=</span><span class="s">"d"</span> <span class="na">d:DesignWidth=</span><span class="s">"800"</span> <span class="na">d:DesignHeight=</span><span class="s">"450"</span>
             <span class="na">x:Class=</span><span class="s">"Avalonia.MusicStore.Views.AlbumView"</span>
             <span class="na">x:DataType=</span><span class="s">"vm:AlbumViewModel"</span>
             <span class="na">Width=</span><span class="s">"200"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;UserControl.Resources&gt;</span>
    <span class="nt">&lt;DrawingImage</span> <span class="na">x:Key=</span><span class="s">"CoverFallback"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;DrawingImage.Drawing&gt;</span>
        <span class="nt">&lt;DrawingGroup</span> <span class="nt">&gt;</span>
          <span class="nt">&lt;GeometryDrawing&gt;</span>
            <span class="nt">&lt;RectangleGeometry</span>  <span class="na">Rect=</span><span class="s">"-2 -2 28 28"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;/GeometryDrawing&gt;</span>
          <span class="nt">&lt;GeometryDrawing</span> <span class="na">Brush=</span><span class="s">"White"</span>
                           <span class="na">Geometry=</span><span class="s">"{DynamicResource music_regular}"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/DrawingGroup&gt;</span>

      <span class="nt">&lt;/DrawingImage.Drawing&gt;</span>
    <span class="nt">&lt;/DrawingImage&gt;</span>
  <span class="nt">&lt;/UserControl.Resources&gt;</span>

  <span class="nt">&lt;StackPanel</span> <span class="na">Spacing=</span><span class="s">"5"</span> <span class="na">Width=</span><span class="s">"200"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Border</span> <span class="na">CornerRadius=</span><span class="s">"10"</span> <span class="na">ClipToBounds=</span><span class="s">"True"</span> <span class="na">Background=</span><span class="s">"#7FFF22DD"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Image</span> <span class="na">Width=</span><span class="s">"200"</span> <span class="na">Height=</span><span class="s">"200"</span>
               <span class="na">Stretch=</span><span class="s">"Uniform"</span>
               <span class="na">Source=</span><span class="s">"{StaticResource CoverFallback}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/Border&gt;</span>
  <span class="nt">&lt;/StackPanel&gt;</span>
<span class="nt">&lt;/UserControl&gt;</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>As the image source we are using a static resource <code>CoverFallback</code> that displays the music note icon above a rectangle. This will act as a placeholder for the album cover art. It is defined in <code>&lt;UserControl.Resources&gt;</code> section.</p>
</div>
<div class="paragraph">
<p>The preview pane will now show the new tile view with the music note icon placed in the center.</p>
</div>
</div>
<div class="sect3">
<h4 id="_view_locator">View Locator</h4>
<div class="paragraph">
<p>The album view model will eventually contain data for the name of an album, the artist, and its downloaded cover art, but at this stage you will continue to use just the placeholder music note icon.</p>
</div>
<div class="paragraph">
<p>As you saw on the last page, at this point the album list currently just shows the (fully qualified) name of the album view model class.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="_docs/15_Album_view_before_template.png" alt="Album view before template"></span></p>
</div>
<div class="paragraph">
<p>In this step you will be using the view locator class (<strong>ViewLocator.cs</strong> file) that was added to the project by the solution template. This class was registered (by the solution template) as a data template at the highest level in the app in the <strong>App.axaml</strong> file. The data template registration looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Application</span> <span class="err">...</span>
             <span class="na">xmlns:local=</span><span class="s">"using:Avalonia.MusicStore"</span>
             <span class="err">...</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;Application.DataTemplates&gt;</span>
        <span class="nt">&lt;local:ViewLocator/&gt;</span>
    <span class="nt">&lt;/Application.DataTemplates&gt;</span>
    ...
<span class="nt">&lt;/Application&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The view locator can therefore always be found by <em>Avalonia UI,</em> when it searches for a data template.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more details about the <strong>data template</strong> concept, see <a href="https://docs.avaloniaui.net/docs/concepts/templates/">[here]</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The view locator acts as a data template for a view model (in this case the album view model) under the conditions that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the view model inherits from the <code>ViewModelBase</code> class,</p>
</li>
<li>
<p>and there is a view that exists with the same base name.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The view <code>AlbumView</code> and the view model <code>AlbumViewModel</code> already have the same base name 'Album' and the view <code>AlbumView</code> exists. So the only remaining condition for the view locator to work is that the view model has to inherit from the <code>ViewModelBase</code> class.</p>
</div>
<div class="paragraph">
<p>Follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>AlbumViewModel.cs</strong> file you created earlier.</p>
</li>
<li>
<p>Add the code for the class to inherit from <code>ViewModelBase</code> as shown and make the class <code>partial</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">AlbumViewModel</span> <span class="p">:</span> <span class="n">ViewModelBase</span>
<span class="p">{</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/16_Album_view_stack_layout.png" alt="Album view with stack panel">
</div>
<div class="title">Figure 11. The album list now shows the graphical tile view</div>
</div>
<div class="paragraph">
<p>The view locator is finding the view <code>AlbumView</code> to use as a data template for the list items.</p>
</div>
</div>
<div class="sect3">
<h4 id="_alternative_explicit_data_template">Alternative: Explicit Data Template</h4>
<div class="paragraph">
<p>If you prefer not to use the view locator approach, you can instead define an explicit data template for the album view model. This can be done at the list box level, or at a higher level such as the user control, window or globally for the App.</p>
</div>
<div class="paragraph">
<p>Here is an example of how to define the data template at the App-level:</p>
</div>
<div class="listingblock">
<div class="title">App.axaml</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Application.DataTemplates&gt;</span>
    <span class="c">&lt;!-- &lt;local:ViewLocator/&gt; --&gt;</span>
    <span class="nt">&lt;DataTemplate</span> <span class="na">DataType=</span><span class="s">"viewModels:AlbumViewModel"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;views:AlbumView</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/DataTemplate&gt;</span>
<span class="nt">&lt;/Application.DataTemplates&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The benefit of using this approach is that it doesn&#8217;t require the conventions and that it doesn&#8217;t rely on reflection. On the downside, it requires you to explicitly define a data template for each view model.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_list_items_panel_template">List Items Panel Template</h4>
<div class="paragraph">
<p>In this step you will tidy up the list display so that the album covers wrap around to fill all the space available.</p>
</div>
<div class="paragraph">
<p>A list box has a property that contains a template control for laying out the list items. By default this is a stack panel. To make the album covers wrap around to fill all the space, you can change the panel template to be a wrap panel.</p>
</div>
<div class="paragraph">
<p>You will also add some style attributes to the list box.</p>
</div>
<div class="paragraph">
<p>To tidy up the list, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>Locate and open the <strong>MusicStoreView.axaml</strong> file.</p>
</li>
<li>
<p>Expand the <code>&lt;ListBox&gt;</code> element so that it has start and end tags.</p>
</li>
<li>
<p>Add the <code>&lt;ListBox.ItemsPanel&gt;</code> XAML shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ListBox</span> <span class="na">ItemsSource=</span><span class="s">"{Binding SearchResults}"</span>
         <span class="na">SelectedItem=</span><span class="s">"{Binding SelectedAlbum}"</span>
         <span class="na">Background=</span><span class="s">"Transparent"</span> <span class="na">Margin=</span><span class="s">"0 20"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ListBox.ItemsPanel&gt;</span>
        <span class="nt">&lt;ItemsPanelTemplate&gt;</span>
            <span class="nt">&lt;WrapPanel</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/ItemsPanelTemplate&gt;</span>
    <span class="nt">&lt;/ListBox.ItemsPanel&gt;</span>
<span class="nt">&lt;/ListBox&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/17_Album_view_wrap_layout.png" alt="Album view with wrap layout">
</div>
<div class="title">Figure 12. The album list now uses a wrap layout</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_album_service">Album Service</h3>
<div class="paragraph">
<p>In the below section, you will add some business logic to the app. This will allow you to replace the mock data and get some real album data from the search. This business logic code forms the 'Model' part of the MVVM pattern.</p>
</div>
<div class="paragraph">
<p>To implement a real album search in the app, you will use a <em>NuGet</em> package that can call the <em>Apple iTunes</em> Web API album search.</p>
</div>
<div class="paragraph">
<p>Firstly, let&#8217;s remove the constructor for mock search that we will not need anymore.
- Go to <strong>MusicStoreViewModel.cs</strong> file.
- Remove constructor.</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="nf">MusicStoreViewModel</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">());</span>
    <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">());</span>
    <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">());</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>+
This constructor was only used for testing the UI with mock data and is no longer needed.</p>
</div>
<div class="sect3">
<h4 id="_apple_web_api_package">Apple Web API Package</h4>
<div class="paragraph">
<p>Follow this procedure to add the required <em>NuGet</em> package:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>Right-click the project.</p>
</li>
<li>
<p>Click <strong>Manage NuGet Packages</strong>.</p>
<div class="imageblock">
<div class="content">
<img src="_docs/18_iTunes_search_nuget.png" alt="iTunes-API nuget package">
</div>
<div class="title">Figure 13. Find the iTunes-API nuget package</div>
</div>
</li>
<li>
<p>Type 'itunes' in the search box (top-left).</p>
</li>
<li>
<p>Click <strong>iTunesSearch</strong>, then click <strong>Install</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_mvvm_model">MVVM Model</h4>
<div class="paragraph">
<p>In this tutorial the application is simple, and you can implement the business services required for the 'Model' part of the MVVM pattern, in one class. This class will contain both the data model for an album, and the method needed for the search.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to add the album business logic:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the solution explorer, right-click the <strong>/Models</strong> folder and then click <strong>Add</strong>.</p>
</li>
<li>
<p>Click <strong>Class</strong> &#8594; <strong>Record</strong>.</p>
</li>
<li>
<p>When prompted for the name, type 'Album'.</p>
</li>
<li>
<p>Add the following code:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">iTunesSearch.Library</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Avalonia.MusicStore.Models</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">record</span> <span class="nc">Album</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">iTunesSearchManager</span> <span class="n">s_SearchManager</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">HttpClient</span> <span class="n">s_httpClient</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

        <span class="k">public</span> <span class="nf">Album</span><span class="p">(</span><span class="kt">string</span> <span class="n">artist</span><span class="p">,</span> <span class="kt">string</span> <span class="n">title</span><span class="p">,</span> <span class="kt">string</span> <span class="n">coverUrl</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Artist</span> <span class="p">=</span> <span class="n">artist</span><span class="p">;</span>
            <span class="n">Title</span> <span class="p">=</span> <span class="n">title</span><span class="p">;</span>
            <span class="n">CoverUrl</span> <span class="p">=</span> <span class="n">coverUrl</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Artist</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Title</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">CoverUrl</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Album</span><span class="p">&gt;&gt;</span> <span class="nf">SearchAsync</span><span class="p">(</span><span class="kt">string</span><span class="p">?</span> <span class="n">searchTerm</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">searchTerm</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">Enumerable</span><span class="p">.</span><span class="n">Empty</span><span class="p">&lt;</span><span class="n">Album</span><span class="p">&gt;();</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">query</span> <span class="p">=</span> <span class="k">await</span> <span class="n">s_SearchManager</span><span class="p">.</span><span class="nf">GetAlbumsAsync</span><span class="p">(</span><span class="n">searchTerm</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

            <span class="k">return</span> <span class="n">query</span><span class="p">.</span><span class="n">Albums</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span>
                <span class="k">new</span> <span class="nf">Album</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">ArtistName</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">CollectionName</span><span class="p">,</span>
                    <span class="n">x</span><span class="p">.</span><span class="n">ArtworkUrl100</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"100x100bb"</span><span class="p">,</span> <span class="s">"600x600bb"</span><span class="p">)));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We use a record for Album since it helps to encapsulate data.
See <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/record">[micsrosoft docs]</a> for more information about records in C#.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_album_view_model">Album View Model</h4>
<div class="paragraph">
<p>In order to display the data from the Web API for each album (data model) in the search results list, you will create an album view model, and this will be bound to the album view (tile) for display.</p>
</div>
<div class="paragraph">
<p>Your album view model is currently empty. It will need to be able to store the album data from the search, and have some properties for the artist name and album title. These will then be bound to the view for display.</p>
</div>
<div class="paragraph">
<p>The cover itself will be loaded asynchronously, so the view model will also need a property for this. It is a Task that returns a <a href="https://api-docs.avaloniaui.net/docs/T_Avalonia_Media_Imaging_Bitmap">[Bitmap]</a>.</p>
</div>
<div class="paragraph">
<p>In this step you will use a common pattern for the dependent relationship between a view model and a (business logic) model. This is where the view model contains an instance of the data model, and then exposes certain of its properties, as required for display.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to prepare the album view model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>AlbumViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add the code as shown:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">private</span> <span class="k">readonly</span> <span class="n">Album</span> <span class="n">_album</span><span class="p">;</span>

<span class="k">public</span> <span class="nf">AlbumViewModel</span><span class="p">(</span><span class="n">Album</span> <span class="n">album</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_album</span> <span class="p">=</span> <span class="n">album</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="kt">string</span> <span class="n">Artist</span> <span class="p">=&gt;</span> <span class="n">_album</span><span class="p">.</span><span class="n">Artist</span><span class="p">;</span>

<span class="k">public</span> <span class="kt">string</span> <span class="n">Title</span> <span class="p">=&gt;</span> <span class="n">_album</span><span class="p">.</span><span class="n">Title</span><span class="p">;</span>

<span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Bitmap</span><span class="p">?&gt;</span> <span class="n">Cover</span> <span class="p">=&gt;</span> <span class="nf">LoadCoverAsync</span><span class="p">();</span>

<span class="c1">// this will be implemented later</span>
<span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Bitmap</span><span class="p">?&gt;</span> <span class="nf">LoadCoverAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that as the view model properties will not change in the UI during runtime, they have no setter and a plain getter.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Since we directly reference <code>Avalonia.Media.Imaging.Bitmap</code> in the view model, we are slightly breaking the MVVM pattern by introducing a UI framework dependency in the view model. In a more complex app, you might want to avoid this by introducing a separate service to handle image loading. A possible solution is to create a helper class as shown <a href="https://docs.avaloniaui.net/docs/guides/data-binding/how-to-bind-image-files">[here]</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_start_the_search">Start the Search</h4>
<div class="paragraph">
<p>In this step, you‚Äôll add the ability to search for albums in real-time as the user types in the music store dialog. When it finishes, the search places its results in the observable collection <code>SearchResults</code>. This collection is already bound to the list box, so with a small adjustment to the album view, the results of the search will display as the tiles you prepared earlier.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to trigger the search with a short delay when the search text changes:
- Locate and open the <strong>MusicStoreView.axaml</strong> file.
- Find the line with SearchText binding and add a Delay property as shown below:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;TextBox</span> <span class="na">Watermark=</span><span class="s">"Search for Albums...."</span> <span class="na">Text=</span><span class="s">"{Binding SearchText, Delay=400}"</span> <span class="nt">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>+
NOTE:`Delay=400` ensures that input is only propagated to the view model after the user pauses for 400ms, preventing unnecessary search calls.</p>
</div>
<div class="paragraph">
<p>Now:
- Locate and open the <strong>MusicStoreViewModel.cs</strong> file.
- Add the following method there:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">partial</span> <span class="k">void</span> <span class="nf">OnSearchTextChanged</span><span class="p">(</span><span class="kt">string</span><span class="p">?</span> <span class="k">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_</span> <span class="p">=</span> <span class="nf">DoSearch</span><span class="p">(</span><span class="n">SearchText</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>+
This method is automatically called whenever the SearchText property changes.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add <code>DoSearch</code> implementation:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DoSearch</span><span class="p">(</span><span class="kt">string</span><span class="p">?</span> <span class="n">term</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">IsBusy</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
    <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">albums</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Album</span><span class="p">.</span><span class="nf">SearchAsync</span><span class="p">(</span><span class="n">term</span><span class="p">);</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">album</span> <span class="k">in</span> <span class="n">albums</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">vm</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">(</span><span class="n">album</span><span class="p">);</span>
        <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">IsBusy</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This method:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sets a busy flag to show the loading spinner in the UI.</p>
</li>
<li>
<p>Clears existing results.</p>
</li>
<li>
<p>Calls the album model&#8217;s <code>SearchAsync</code> method to fetch data from the iTunes API.</p>
</li>
<li>
<p>Wraps each result in an <code>AlbumViewModel</code> and adds it to <code>SearchResults</code>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Now your <strong>MusicStoreViewModel</strong> file should now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.ObjectModel</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Avalonia.MusicStore.Messages</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Avalonia.MusicStore.Models</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.Input</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.Messaging</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Avalonia.MusicStore.ViewModels</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">MusicStoreViewModel</span> <span class="p">:</span> <span class="n">ViewModelBase</span>
    <span class="p">{</span>
        <span class="p">[</span><span class="n">ObservableProperty</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">partial</span> <span class="kt">string</span><span class="p">?</span> <span class="n">SearchText</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="p">[</span><span class="n">ObservableProperty</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">partial</span> <span class="kt">bool</span> <span class="n">IsBusy</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="p">[</span><span class="n">ObservableProperty</span><span class="p">]</span>
        <span class="k">public</span> <span class="k">partial</span> <span class="n">AlbumViewModel</span><span class="p">?</span> <span class="n">SelectedAlbum</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="n">ObservableCollection</span><span class="p">&lt;</span><span class="n">AlbumViewModel</span><span class="p">&gt;</span> <span class="n">SearchResults</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

        <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DoSearch</span><span class="p">(</span><span class="kt">string</span><span class="p">?</span> <span class="n">term</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">IsBusy</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">albums</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Album</span><span class="p">.</span><span class="nf">SearchAsync</span><span class="p">(</span><span class="n">term</span><span class="p">);</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">album</span> <span class="k">in</span> <span class="n">albums</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">vm</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">(</span><span class="n">album</span><span class="p">);</span>
                <span class="n">SearchResults</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">IsBusy</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">partial</span> <span class="k">void</span> <span class="nf">OnSearchTextChanged</span><span class="p">(</span><span class="kt">string</span> <span class="k">value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_</span> <span class="p">=</span> <span class="nf">DoSearch</span><span class="p">(</span><span class="n">SearchText</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bind_the_album_view">Bind the Album View</h4>
<div class="paragraph">
<p>Your work on the previous page to format the album 'tile' view did not add any way to display the text results of the search.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to add the album name and artist name to the tile:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>AlbumView.axaml</strong> file.</p>
</li>
<li>
<p>Replace the path icon with an image control that will display the album cover.</p>
</li>
<li>
<p>Add the two text block controls with their data bindings, as shown:</p>
</li>
<li>
<p>To have compiled binding working, you need to indicate the datatype used in the view : <code>AlbumViewModel</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;UserControl</span> <span class="err">...</span>
  <span class="na">xmlns:vm=</span><span class="s">"using:Avalonia.MusicStore.ViewModels"</span>
  <span class="na">x:DataType=</span><span class="s">"vm:AlbumViewModel"</span> <span class="nt">&gt;</span>
  [ ... ]
  <span class="nt">&lt;StackPanel</span> <span class="na">Spacing=</span><span class="s">"5"</span> <span class="na">Width=</span><span class="s">"200"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Border</span> <span class="na">CornerRadius=</span><span class="s">"10"</span> <span class="na">ClipToBounds=</span><span class="s">"True"</span> <span class="na">Background=</span><span class="s">"#7FFF22DD"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Image</span> <span class="na">Width=</span><span class="s">"200"</span> <span class="na">Height=</span><span class="s">"200"</span>
               <span class="na">Stretch=</span><span class="s">"Uniform"</span>
               <span class="na">Source=</span><span class="s">"{Binding Cover^, TargetNullValue={StaticResource CoverFallback}, FallbackValue={StaticResource CoverFallback}}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/Border&gt;</span>
    <span class="nt">&lt;TextBlock</span> <span class="na">HorizontalAlignment=</span><span class="s">"Center"</span> <span class="na">Text=</span><span class="s">"{Binding Title}"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;TextBlock</span> <span class="na">HorizontalAlignment=</span><span class="s">"Center"</span> <span class="na">Text=</span><span class="s">"{Binding Artist}"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/StackPanel&gt;</span>
<span class="nt">&lt;/UserControl&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
<li>
<p>Type some search text.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="_docs/19_Album_search_results.png" alt="Search results example"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_displaying_images">Displaying Images</h3>
<div class="paragraph">
<p>You will now learn how to retrieve the cover art bitmap for each album in the search results. You will then be able to display the image on each album tile view instead of the placeholder note icon.</p>
</div>
<div class="sect3">
<h4 id="_album_service_2">Album Service</h4>
<div class="paragraph">
<p>Your first step is to modify the business service to retrieve the album cover art from the <em>Apple iTunes</em> Web API.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to get the album cover art from the Web API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is still running.</p>
</li>
<li>
<p>Locate and open the <strong>Album.cs</strong> file in the <strong>/Models</strong> folder.</p>
</li>
<li>
<p>Add the code as shown:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">private</span> <span class="k">static</span> <span class="n">HttpClient</span> <span class="n">s_httpClient</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
<span class="k">private</span> <span class="kt">string</span> <span class="n">CachePath</span> <span class="p">=&gt;</span> <span class="s">$"./Cache/</span><span class="p">{</span><span class="nf">SanitizeFileName</span><span class="p">(</span><span class="n">Artist</span><span class="p">)}</span><span class="s"> - </span><span class="p">{</span><span class="nf">SanitizeFileName</span><span class="p">(</span><span class="n">Title</span><span class="p">)}</span><span class="s">"</span><span class="p">;</span>

<span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Stream</span><span class="p">&gt;</span> <span class="nf">LoadCoverBitmapAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">CachePath</span> <span class="p">+</span> <span class="s">".bmp"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">File</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="n">CachePath</span> <span class="p">+</span> <span class="s">".bmp"</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span>  <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">,</span> <span class="n">FileShare</span><span class="p">.</span><span class="n">Read</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">await</span> <span class="n">s_httpClient</span><span class="p">.</span><span class="nf">GetByteArrayAsync</span><span class="p">(</span><span class="n">CoverUrl</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">SanitizeFileName</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">c</span> <span class="k">in</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetInvalidFileNameChars</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">input</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sc">'_'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">input</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Method <code>LoadCoverBitmapAsync()</code> returns a stream that can be used to load a bitmap from, either from a cache file or from the API.
Method  <code>SanitizeFileName()</code> sanitizes input to replace characters that cannot be used in the file name with <code>_</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that the cache is not active at this time, you will implement it later in the tutorial.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>So that you will see as soon as the cache becomes active, place a debug breakpoint at the following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">return</span> <span class="n">File</span><span class="p">.</span><span class="nf">OpenRead</span><span class="p">(</span><span class="n">CachePath</span> <span class="p">+</span> <span class="s">".bmp"</span><span class="p">);</span></code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_album_view_model_2">Album View Model</h4>
<div class="paragraph">
<p>In this step , you will add a property to the album view model to store the cover art as a bitmap.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please note that you must reference <code>Avalonia.Media.Imaging</code> in the album view model because you must use the <em>Avalonia UI</em> bitmap here, and <strong>not</strong> the .NET <code>System.Bitmap</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Follow this procedure to update the album view model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>AlbumViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add the following code into the <code>LoadCoverAsync</code> method, replacing the existing code:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">Avalonia.Media.Imaging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.ComponentModel</span><span class="p">;</span>
<span class="p">...</span>

<span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">AlbumViewModel</span> <span class="p">:</span> <span class="n">ViewModelBase</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="k">public</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Bitmap</span><span class="p">?&gt;</span> <span class="n">Cover</span> <span class="p">=&gt;</span> <span class="nf">LoadCoverAsync</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">LoadCover</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">// We wait a few ms to demonstrate that the images are loaded in the background.</span>
            <span class="c1">// Remove this line in production.</span>
            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">200</span><span class="p">);</span>

            <span class="k">await</span> <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">imageStream</span> <span class="p">=</span> <span class="k">await</span> <span class="n">_album</span><span class="p">.</span><span class="nf">LoadCoverBitmapAsync</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Bitmap</span><span class="p">.</span><span class="nf">DecodeToWidth</span><span class="p">(</span><span class="n">imageStream</span><span class="p">,</span> <span class="m">400</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Take some time to examine this code because it gives an insight into manipulating images with <em>Avalonia UI.</em> For example, the above uses the <code>DecodeToWidth</code> method to convert the image stream for display in <em>Avalonia UI</em>. This method can convert a stream for a large high resolution image into a smaller bitmap, at a specified width and while maintaining the aspect ratio.</p>
</div>
<div class="paragraph">
<p>This means that you will not waste large amounts of memory to display the album cover art, even though the Web API returns quite large files.</p>
</div>
<div class="paragraph">
<p>Also notice how the <code>LoadCover</code> method is coded to run asynchronously, and on a background thread. This is so that the UI thread does not get blocked and make the UI unresponsive.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Avalonia has a special operator <code>^</code> that you can use in data bindings to indicate that the bound property is a <code>Task&lt;T&gt;</code>. This operator will automatically unwrap the task and return the result when it is available. You used this operator in the album view XAML earlier. See <a href="https://docs.avaloniaui.net/docs/guides/data-binding/how-to-bind-to-a-task-result">[Avalonia docs]</a> for more information about this operator.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/20_displaying_images.png" alt="Displaying images for the albums">
</div>
<div class="title">Figure 14. This is how the album covers now appear in the search results</div>
</div>
<div class="paragraph">
<p>Notice how the album covers load one by one, and the UI remains responsive.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_dialog_return">Dialog Return</h3>
<div class="paragraph">
<p>Next, you‚Äôll complete the logic for returning a selected album from the search dialog <code>MusicStoreWindow</code> back to the main window. This will be done using the <em>CommunityToolkit.Mvvm</em> messaging system, allowing the dialog to communicate back without tight coupling. Since you don&#8217;t want to add the same album multiple times, you will also implement logic to add the album only if it is not already in the user&#8217;s collection.</p>
</div>
<div class="sect3">
<h4 id="_create_the_musicstoreclosedmessage_class">Create the MusicStoreClosedMessage Class</h4>
<div class="paragraph">
<p>Firstly, let&#8217;s create a message class that will carry the selected album from the dialog to the window handler.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the previously created <strong>/Messages</strong> folder add new class <code>MusicStoreClosedMessage</code>.</p>
</li>
<li>
<p>In the newly created file add the following code:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">Avalonia.MusicStore.ViewModels</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Avalonia.MusicStore.Messages</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">MusicStoreClosedMessage</span><span class="p">(</span><span class="n">AlbumViewModel</span> <span class="n">selectedAlbum</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">AlbumViewModel</span> <span class="n">SelectedAlbum</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="n">selectedAlbum</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_create_the_checkalbumalreadyexistsmessage_class">Create the CheckAlbumAlreadyExistsMessage Class</h4>
<div class="paragraph">
<p>Next, you will create a message class that will be used to check if an album already exists in the user&#8217;s collection.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the <strong>/Messages</strong> folder add new class <code>CheckAlbumAlreadyExistsMessage</code>.</p>
</li>
<li>
<p>In the newly created file add the following code:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">CheckAlbumAlreadyExistsMessage</span> <span class="p">:</span> <span class="n">RequestMessage</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">AlbumViewModel</span> <span class="n">Album</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">CheckAlbumAlreadyExistsMessage</span><span class="p">(</span><span class="n">AlbumViewModel</span> <span class="n">album</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Album</span> <span class="p">=</span> <span class="n">album</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_create_the_notificationmessage_class">Create the NotificationMessage Class</h4>
<div class="paragraph">
<p>As the last message to implement, you will create a message class that will be used to show notification messages to the user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the <strong>/Messages</strong> folder add new class <code>NotificationMessage</code>.</p>
</li>
<li>
<p>In the newly created file add the following code:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">NotificationMessage</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">NotificationMessage</span><span class="p">(</span><span class="kt">string</span> <span class="n">message</span><span class="p">)</span>
     <span class="p">{</span>
         <span class="n">Message</span> <span class="p">=</span> <span class="n">message</span><span class="p">;</span>
     <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_register_the_message_handlers_in_musicstorewindow">Register the Message Handlers in MusicStoreWindow</h4>
<div class="paragraph">
<p>To close the dialog and return the selected album to the main window, you‚Äôll register a handler that listens for a <code>MusicStoreClosedMessage</code>. In addition we add a handler that can show notification messages to the user, in case the album already exists in the user&#8217;s collection.
- Locate and open the <strong>MusicStoreWindow.axaml.cs</strong> file.
- Add the following code to the constructor:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="nn">Avalonia.Controls</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Avalonia.MusicStore.Messages</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">CommunityToolkit.Mvvm.Messaging</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Avalonia.MusicStore.Views</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">MusicStoreWindow</span> <span class="p">:</span> <span class="n">Window</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="nf">MusicStoreWindow</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">InitializeComponent</span><span class="p">();</span>

            <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">MusicStoreWindow</span><span class="p">,</span> <span class="n">MusicStoreClosedMessage</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">,</span>
                <span class="k">static</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">w</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">SelectedAlbum</span><span class="p">));</span>

            <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">MusicStoreWindow</span><span class="p">,</span> <span class="n">NotificationMessage</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">,</span> <span class="k">static</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">=&gt;</span>
            <span class="p">{</span>
                <span class="n">w</span><span class="p">.</span><span class="n">NotificationManager</span><span class="p">.</span><span class="nf">CloseAll</span><span class="p">();</span>
                <span class="n">w</span><span class="p">.</span><span class="n">NotificationManager</span><span class="p">.</span><span class="nf">Show</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Message</span><span class="p">,</span> <span class="n">NotificationType</span><span class="p">.</span><span class="n">Warning</span><span class="p">,</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">3</span><span class="p">));</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When <code>MusicStoreViewModel</code> sends a <code>MusicStoreClosedMessage</code>, this handler will close the dialog and return the selected album using Avalonia‚Äôs dialog result system.</p>
</div>
<div class="paragraph">
<p>When a <code>NotificationMessage</code> is received, this handler will display the message to the user using the notification manager defined in the XAML.</p>
</div>
</div>
<div class="sect3">
<h4 id="_define_the_command_in_musicstoreviewmodel">Define the Command in MusicStoreViewModel</h4>
<div class="paragraph">
<p>Now you will add a relay command to the music store view model. You will bind this command to the <strong>Buy Album</strong> button on the music store view. The command will only be executable when an album is selected in the list. When executed, it first check if the album already exists in the user&#8217;s collection, and if not, it sends a <code>MusicStoreClosedMessage</code> with the selected album. If the album already exists, it sends a <code>NotificationMessage</code> to inform the user.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add the following RelayCommand method to the class, as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="p">[</span><span class="nf">RelayCommand</span> <span class="p">(</span><span class="n">CanExecute</span> <span class="p">=</span> <span class="k">nameof</span><span class="p">(</span><span class="n">CanBuyMusic</span><span class="p">))]</span>
<span class="k">private</span> <span class="k">void</span> <span class="nf">BuyMusic</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">SelectedAlbum</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">album_exists</span> <span class="p">=</span> <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="k">new</span> <span class="nf">CheckAlbumAlreadyExistsMessage</span><span class="p">(</span><span class="n">SelectedAlbum</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">album_exists</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="k">new</span> <span class="nf">NotificationMessage</span><span class="p">(</span><span class="s">"This album was already added"</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="k">new</span> <span class="nf">MusicStoreClosedMessage</span><span class="p">(</span><span class="n">SelectedAlbum</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">private</span> <span class="kt">bool</span> <span class="nf">CanBuyMusic</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="n">SelectedAlbum</span> <span class="p">!=</span> <span class="k">null</span><span class="p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>The command should be invalidated when the selected album changes. To do this, add the <code>NotifyCanExecuteChangedFor</code>-attribute to the <code>SelectedAlbum</code> property:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="p">[</span><span class="n">ObservableProperty</span><span class="p">]</span>
<span class="p">[</span><span class="nf">NotifyCanExecuteChangedFor</span><span class="p">(</span><span class="k">nameof</span><span class="p">(</span><span class="n">BuyMusicCommand</span><span class="p">))]</span>
<span class="k">public</span> <span class="k">partial</span> <span class="n">AlbumViewModel</span><span class="p">?</span> <span class="n">SelectedAlbum</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_implement_the_album_existence_check_in_mainviewmodel">Implement the Album Existence Check in MainViewModel</h4>
<div class="paragraph">
<p>The MainViewModel will handle the <code>CheckAlbumAlreadyExistsMessage</code> to determine if the selected album is already in the user&#8217;s collection. To do this, you will implement a message handler that checks the observable collection of albums for the presence of the selected album.</p>
</div>
<div class="paragraph">
<p>In the <strong>MainViewModel.cs</strong> file, add the following code to the constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="nf">MainViewModel</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Register</span><span class="p">&lt;</span><span class="n">CheckAlbumAlreadyExistsMessage</span><span class="p">&gt;(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="n">m</span><span class="p">.</span><span class="nf">Reply</span><span class="p">(</span><span class="n">Albums</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">Album</span><span class="p">));</span>
    <span class="p">});</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An album is considered to be equal, if both the artist name and the album title are the same. The default equality comparer for records in C# checks all properties for equality, so no additional implementation is needed in the <code>Album</code> class. However, in the <code>AlbumViewModel</code> class, you need to override the equality members to delegate the comparison to the underlying <code>Album</code> model.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="k">partial</span> <span class="k">class</span> <span class="nc">AlbumViewModel</span> <span class="p">:</span> <span class="n">ViewModelBase</span><span class="p">,</span> <span class="n">IEquatable</span><span class="p">&lt;</span><span class="n">AlbumViewModel</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="p">...</span>

    <span class="k">public</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="n">AlbumViewModel</span><span class="p">?</span> <span class="n">other</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">other</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">ReferenceEquals</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">_album</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">_album</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">Equals</span><span class="p">(</span><span class="kt">object</span><span class="p">?</span> <span class="n">obj</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nf">ReferenceEquals</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span> <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="nf">GetType</span><span class="p">()</span> <span class="p">!=</span> <span class="nf">GetType</span><span class="p">())</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="nf">Equals</span><span class="p">((</span><span class="n">AlbumViewModel</span><span class="p">)</span><span class="n">obj</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="kt">int</span> <span class="nf">GetHashCode</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">_album</span><span class="p">.</span><span class="nf">GetHashCode</span><span class="p">();</span>
    <span class="p">}</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can learn more about the <code>IEquatable&lt;T&gt;</code> interface and overriding equality members in C# from the Microsoft docs <a href="https://learn.microsoft.com/en-us/dotnet/api/system.iequatable-1">[here]</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_bind_the_command_to_the_button">Bind the Command to the Button</h4>
<div class="paragraph">
<p>Your next step is bind the <strong>Buy Album</strong> button to the relay command in the music store view model, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MusicStoreView.axaml</strong> file.</p>
</li>
<li>
<p>Add the data binding <code>Command="{Binding BuyMusicCommand}"</code> to the button element.</p>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
<li>
<p>Type some search text.</p>
</li>
<li>
<p>Click an album to select it.</p>
</li>
<li>
<p>Click <strong>Buy Album</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will see the dialog close, but nothing happens in the main window!</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_add_items_to_the_users_collection">Add Items to the User&#8217;s Collection</h3>
<div class="paragraph">
<p>On this page you will implement a collection of albums that the user has selected using the search dialog and the <strong>Buy Album</strong> button, and display them in the main window.</p>
</div>
<div class="sect3">
<h4 id="_observable_collection">Observable Collection</h4>
<div class="paragraph">
<p>Your first step here is to add an observable collection to the main window view model. This will hold the albums that the user has selected using the search dialog.</p>
</div>
<div class="paragraph">
<p>Follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is running.</p>
</li>
<li>
<p>Locate and open the <strong>MainViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add an observable collection, as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="n">ObservableCollection</span><span class="p">&lt;</span><span class="n">AlbumViewModel</span><span class="p">&gt;</span> <span class="n">Albums</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_process_the_dialog_result">Process the Dialog Result</h4>
<div class="paragraph">
<p>Your next step is to alter the <code>AddAlbumAsync</code> command so that it adds the dialog return object (an <code>AlbumViewModel</code>) to the observable collection. Follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In the same <strong>MainViewModel.cs</strong> file update the <code>AddAlbumAsync()</code> command method:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="p">[</span><span class="n">RelayCommand</span><span class="p">]</span>
<span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddAlbumAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">album</span> <span class="p">=</span> <span class="k">await</span> <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="k">new</span> <span class="nf">PurchaseAlbumMessage</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">album</span> <span class="k">is</span> <span class="n">not</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Albums</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">album</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_main_window_view">Main Window View</h4>
<div class="paragraph">
<p>Next you will add XAML to the main window view to display the items in the observable collection. Again you will use a <strong>data template</strong>, this time inside an <code>ItemsControl</code>. The items control is actually  the base class for controls that display multiple items (like the list box), so some of this will already be familiar.</p>
</div>
<div class="paragraph">
<p>To add the items control and its data template, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MainWindow.axaml</strong> file.</p>
</li>
<li>
<p>Add the following namespace declaration to the <code>&lt;Window&gt;</code> element:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">xmlns:views="clr-namespace:Avalonia.MusicStore.Views"</code></pre>
</div>
</div>
</li>
<li>
<p>Under the button element, add the XAML as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;ScrollViewer</span> <span class="na">VerticalScrollBarVisibility=</span><span class="s">"Auto"</span> <span class="na">Margin=</span><span class="s">"0 40 0 0"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;ItemsControl</span> <span class="na">ItemsSource=</span><span class="s">"{Binding Albums}"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ItemsControl.ItemsPanel&gt;</span>
      <span class="nt">&lt;ItemsPanelTemplate&gt;</span>
        <span class="nt">&lt;WrapPanel</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/ItemsPanelTemplate&gt;</span>
    <span class="nt">&lt;/ItemsControl.ItemsPanel&gt;</span>

    <span class="nt">&lt;ItemsControl.ItemTemplate&gt;</span>
      <span class="nt">&lt;DataTemplate&gt;</span>
        <span class="nt">&lt;views:AlbumView</span> <span class="na">Margin=</span><span class="s">"0 0 20 20"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/DataTemplate&gt;</span>
    <span class="nt">&lt;/ItemsControl.ItemTemplate&gt;</span>
  <span class="nt">&lt;/ItemsControl&gt;</span>
<span class="nt">&lt;/ScrollViewer&gt;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
<li>
<p>Type some search text.</p>
</li>
<li>
<p>Click an album to select it.</p>
</li>
<li>
<p>Click <strong>Buy Album</strong>.</p>
</li>
<li>
<p>Repeat another time.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/21_user_album_collection.png" alt="User&#8217;s bought albums">
</div>
<div class="title">Figure 15. Showing the user&#8217;s album collection in the main window</div>
</div>
<div class="paragraph">
<p>You will see the user&#8217;s album collection building as you search and select. However, if you stop the app running and then start it again, the collection reverts to empty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_add_data_persistence">Add Data Persistence</h3>
<div class="paragraph">
<p>Finally. you will add some code to the album model (business service) to save the user&#8217;s album collection to disk, so that it can be recovered when the app next runs.</p>
</div>
<div class="paragraph">
<p>As a welcome side-effect, this will also activate the album cover cache - so that album cover images can be retrieved from disk (if they exist), rather than from the Web API.</p>
</div>
<div class="sect3">
<h4 id="_album_model">Album Model</h4>
<div class="paragraph">
<p>Follow this procedure to add persistence services (save and load) to the album model:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is running.</p>
</li>
<li>
<p>Locate and open the <strong>Album.cs</strong> file in the <strong>/Models</strong> folder.</p>
</li>
<li>
<p>Add the code to implement save to disk, as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">SaveAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">Directory</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="s">"./Cache"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Directory</span><span class="p">.</span><span class="nf">CreateDirectory</span><span class="p">(</span><span class="s">"./Cache"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">OpenWrite</span><span class="p">(</span><span class="n">CachePath</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="nf">SaveToStreamAsync</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="n">Stream</span> <span class="nf">SaveCoverBitmapStream</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">File</span><span class="p">.</span><span class="nf">OpenWrite</span><span class="p">(</span><span class="n">CachePath</span> <span class="p">+</span> <span class="s">".bmp"</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">SaveToStreamAsync</span><span class="p">(</span><span class="n">Album</span> <span class="n">data</span><span class="p">,</span> <span class="n">Stream</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">SerializeAsync</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">data</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Add the code to implement load from disk, as shown:</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Album</span><span class="p">&gt;</span> <span class="nf">LoadFromStream</span><span class="p">(</span><span class="n">Stream</span> <span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="n">DeserializeAsync</span><span class="p">&lt;</span><span class="n">Album</span><span class="p">&gt;(</span><span class="n">stream</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">))!;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">Album</span><span class="p">&gt;&gt;</span> <span class="nf">LoadCachedAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">Directory</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="s">"./Cache"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">Directory</span><span class="p">.</span><span class="nf">CreateDirectory</span><span class="p">(</span><span class="s">"./Cache"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Album</span><span class="p">&gt;();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">file</span> <span class="k">in</span> <span class="n">Directory</span><span class="p">.</span><span class="nf">EnumerateFiles</span><span class="p">(</span><span class="s">"./Cache"</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="k">new</span> <span class="nf">DirectoryInfo</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="n">Extension</span><span class="p">))</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="k">await</span> <span class="k">using</span> <span class="nn">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">OpenRead</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">await</span> <span class="n">Album</span><span class="p">.</span><span class="nf">LoadFromStream</span><span class="p">(</span><span class="n">fs</span><span class="p">).</span><span class="nf">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_album_view_model_3">Album View Model</h4>
<div class="paragraph">
<p>Your next step is to add a method to the album view model that it can call the business service persistence save methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">SaveAsync</dt>
<dd>
<p>persists the album text data as a JSON file,</p>
</dd>
<dt class="hdlist1">SaveCoverBitmapStream</dt>
<dd>
<p>saves the cover art as a bitmap (.BMP) file.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>To alter the album view model , follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>AlbumViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add the method as shown:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">SaveToDiskAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">_album</span><span class="p">.</span><span class="nf">SaveAsync</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">await</span> <span class="nf">LoadCoverAsync</span><span class="p">()</span> <span class="k">is</span> <span class="n">Bitmap</span> <span class="n">cover</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">bitmap</span> <span class="p">=</span> <span class="n">Cover</span><span class="p">;</span>

        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Run</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="n">_album</span><span class="p">.</span><span class="nf">SaveCoverBitmapStream</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">cover</span><span class="p">.</span><span class="nf">Save</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, you will notice that the bitmap is saved from a copy in case the <code>Cover</code> property gets changed mid-operation by another thread.</p>
</div>
</div>
<div class="sect3">
<h4 id="_main_window_view_model">Main Window View Model</h4>
<div class="paragraph">
<p>Lastly, you will call the new album view model persistence method <code>SaveToDiskAsync</code> whenever the dialog returns with a non-null result.</p>
</div>
<div class="paragraph">
<p>To alter the main window view model, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Locate and open the <strong>MainViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add the code <code>await result.SaveToDiskAsync();</code> as shown below.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Your code to initialize the relay command will now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="p">[</span><span class="n">RelayCommand</span><span class="p">]</span>
<span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">AddAlbumAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">album</span> <span class="p">=</span> <span class="k">await</span> <span class="n">WeakReferenceMessenger</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">Send</span><span class="p">(</span><span class="k">new</span> <span class="nf">PurchaseAlbumMessage</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">album</span> <span class="k">is</span> <span class="n">not</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Albums</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">album</span><span class="p">);</span>
        <span class="k">await</span> <span class="n">album</span><span class="p">.</span><span class="nf">SaveToDiskAsync</span><span class="p">();</span> <span class="c1">// Add this line</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
<li>
<p>Type some search text.</p>
</li>
<li>
<p>Click an album to select it.</p>
</li>
<li>
<p>Click <strong>Buy Album</strong>.</p>
</li>
<li>
<p>Repeat another time for a different album.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will not see any difference in the app yet. But you can check to see that the persistence files are being written. To do this open the project location and browse to the <strong>/bin/Debug</strong> folder. Open the folder for your .NET version, and you will find the <strong>/Cache</strong> folder there. You will see two cache files for each of the albums that you just selected.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bitmap_cache_activated">Bitmap Cache Activated</h4>
<div class="paragraph">
<p>Notice that because the <code>SaveToDiskAsync</code> method writes both the JSON data and the album cover art bitmap to the cache folder, this step has effectively activated the bitmap loading cache behaviour that you built earlier. This is where: if an album cover has already been retrieved from the Web API and saved to the cache, the next bitmap load will be from the file not the API - saving time and making the app more responsive.</p>
</div>
<div class="paragraph">
<p>To show that the bitmap loading cache is now in operation, follow this procedure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is running.</p>
</li>
<li>
<p>Locate and open the <strong>Album.cs</strong> file in the <strong>/Models</strong> folder.</p>
</li>
<li>
<p>Check to see that there is still a debug breakpoint in the <code>LoadCoverBitmapAsync</code> method at this line:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">return</span> <span class="n">File</span><span class="p">.</span><span class="nf">OpenRead</span><span class="p">(</span><span class="n">CachePath</span> <span class="p">+</span> <span class="s">".bmp"</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
<li>
<p>Click the icon button.</p>
</li>
<li>
<p>Type the same search text you just used.</p>
</li>
<li>
<p>Select one of the <em>same</em> albums from the previous test run.</p>
</li>
<li>
<p>Click <strong>Buy Album</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The debug breakpoint should stop the app. This demonstrates that the album art is about to be read from disk, rather than retrieved from the Web API.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_load_data_at_start_up">Load Data at Start-up</h3>
<div class="paragraph">
<p>But wait, the data is not restored on start-up yet. So you will add code to load the user&#8217;s album collection from disk when the app starts.</p>
</div>
<div class="paragraph">
<p>You have already added code to the business service that can load both the files you will need from disk. All that remains for you to do, is to add some code to the main window view model to handle the start-up.</p>
</div>
<div class="paragraph">
<p>Follow this procedure to add a method to load the user&#8217;s album collection from disk:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Stop the app if it is running</p>
</li>
<li>
<p>Locate and open the <strong>MainViewModel.cs</strong> file.</p>
</li>
<li>
<p>Add the code as shown:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">private</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">LoadAlbums</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">albums</span> <span class="p">=</span> <span class="p">(</span><span class="k">await</span> <span class="n">Album</span><span class="p">.</span><span class="nf">LoadCachedAsync</span><span class="p">()).</span><span class="nf">Select</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">AlbumViewModel</span><span class="p">(</span><span class="n">x</span><span class="p">)).</span><span class="nf">ToList</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">album</span> <span class="k">in</span> <span class="n">albums</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Albums</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">album</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see this method uses the business service to load the list of albums from the disk cache. It then transforms each data model (<code>Album</code> class) into a view model (<code>AlbumViewModel</code> class). After this all the album view models are added to the observable collection - this will instantly update the UI with the text data for the albums.</p>
</div>
<div class="paragraph">
<p>Your next step is to schedule the <code>LoadAlbum</code> method to run when the app starts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep the <strong>MainViewModel.cs</strong> file open.</p>
</li>
<li>
<p>Call LoadAlbums() from the MainViewModel constructor:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">public</span> <span class="nf">MainViewModel</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nf">LoadAlbums</span><span class="p">();</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this change, now the app will automatically load previously added albums every time it starts.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Click <strong>Debug</strong> to compile and run the project.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="_docs/22_final_result.png" alt="Final result">
</div>
<div class="title">Figure 16. Well done, this is the final result of the Music Store App tutorial</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this tutorial you have seen how <em>Avalonia UI</em> can be used to create a highly graphical desktop app.</p>
</div>
<div class="sect3">
<h4 id="_application_solution_architecture">Application Solution Architecture</h4>
<div class="paragraph">
<p>This tutorial has used an application solution architecture that uses the MVVM pattern with the help of the <em>CommunityToolkit.Mvvm</em> framework. It manages multiple windows from the code-behind files.</p>
</div>
<div class="paragraph">
<p>Application state is kept in the 'top level' view model, and can be persisted to disk. The main window and search dialog are composed from in <em>Avalonia UI</em> window controls, built-in controls and user controls.</p>
</div>
<div class="paragraph">
<p>This tutorial application targets a windowing platform such as <em>Apple Mac OS</em> or <em>Windows</em>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To learn more about targeting applications for iOS (Apple) platforms, see <a href="https://docs.avaloniaui.net/docs/guides/platforms/ios">[here]</a>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To learn more about targeting applications for Android mobile devices, see <a href="https://docs.avaloniaui.net/docs/guides/platforms/android">[here]</a>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-11-07 18:17:52 UTC
</div>
</div>
</body>
</html>