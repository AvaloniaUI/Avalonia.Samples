
name: Run tests

on: [push, pull_request]

jobs:
  test:
    runs-on: windows-latest
    name: Build all projects to test the code
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '10.0.x'

      - name: Setup Android SDK
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: android-actions/setup-android@v2
      
      - name: Install workloads for Mobile and Wasm projects
        run: |
          dotnet workload restore ./src/Avalonia.Samples/CompleteApps/AdvancedToDoList/AdvancedToDoList.Android/AdvancedToDoList.Android.csproj
          dotnet workload restore ./src/Avalonia.Samples/CompleteApps/AdvancedToDoList/AdvancedToDoList.Browser/AdvancedToDoList.Browser.csproj
          dotnet workload restore ./src/Avalonia.Samples/CompleteApps/AdvancedToDoList/AdvancedToDoList.iOS/AdvancedToDoList.iOS.csproj
        working-directory: ./

      - name: Build all solutions with diagnostics
        run: |
          $solutions = Get-ChildItem -Path "./src/Avalonia.Samples" -Filter "*.sln*" -Recurse | Select-Object -ExpandProperty FullName
          foreach ($solution in $solutions) {
            Write-Host "=== Restoring: $solution ==="
            dotnet restore $solution --ignore-failed-sources --verbosity:detailed
            Write-Host "=== Building: $solution ==="
            dotnet build $solution --no-restore --verbosity:detailed
          }
        shell: pwsh
        env:
          MSBUILDSINGLEPROCESSBUILD: "1"
          DOTNET_CLI_TELEMETRY_PROFILE: "True"
          NUGET_VERBOSITY: "detailed"